/// <reference path="../typings/tsd.d.ts" />
var _path = require('path');
var _glob = require('glob');
var _util = require('./util');
var _compiler = require('./compiler');
var _adapter = require('./adapter');
var _lang = require('./lang');
var S_TYPESCRIPT = 'typescript';
function plugin(config, globs) {
    var result = new _compiler.Result();
    if (!_lang.isObject(config)) {
        throw new _util.PluginError("The config argument is not an object");
    }
    if (!_lang.isString(globs)) {
        if (!Array.isArray(globs) || !globs.every(_lang.isString)) {
            throw new _util.PluginError("The globs argument is not a string or array of strings");
        }
    }
    else {
        globs = [globs];
    }
    var fileNames = findFiles(globs);
    if (!fileNames.length) {
        throw new _util.PluginError("The matched file set is empty");
    }
    var adapter = loadAdapter(config);
    var options = parseOptions(adapter.options(), config, result);
    if (result.diagnostics.length) {
        result.reportDiagnostics();
    }
    else {
        adapter.compile(options, fileNames, result);
        if (result.diagnostics.length) {
            result.reportDiagnostics();
        }
    }
    return result;
}
function findFiles(globs) {
    var fileNames = [];
    for (var _i = 0; _i < globs.length; _i++) {
        var glob = globs[_i];
        fileNames = fileNames.concat(_glob.sync(glob, { nodir: true }));
    }
    return fileNames.map(resolvePath).filter(unique);
    function unique(value, index, array) {
        return array.indexOf(value) === index;
    }
}
function loadAdapter(config) {
    if (S_TYPESCRIPT in config) {
        return _adapter.load(config[S_TYPESCRIPT]);
    }
    else {
        return _adapter.load(require('typescript'));
    }
}
function parseOptions(optionsList, config, result) {
    var options = Object.create(null);
    var optionsMap = _lang.groupBy(optionsList, 'name');
    _lang.forEach(config, validate);
    if (options.rootDir == null) {
        options.rootDir = resolvePath('.');
    }
    return options;
    function validate(name, value) {
        if (name === S_TYPESCRIPT) {
        }
        else if (name in optionsMap) {
            var option = optionsMap[name];
            switch (option.type) {
                case 'string':
                    if (!_lang.isString(value)) {
                        error("Expected string value of the config property '" + name + "'");
                        return;
                    }
                    break;
                case 'number':
                    if (!_lang.isNumber(value)) {
                        error("Expected number value of the config property '" + name + "'");
                        return;
                    }
                    break;
                case 'boolean':
                    if (!_lang.isBoolean(value)) {
                        error("Expected boolean value of the config property '" + name + "'");
                        return;
                    }
                    break;
                default:
                    if (value in option.type) {
                        value = option.type[value];
                    }
                    else {
                        error(("Unknown value '" + value + "' of the config property '" + name + "', ") +
                            ("expected one of " + Object.keys(option.type).map(function (s) { return ("'" + s + "'"); }).join(', ')));
                        return;
                    }
                    break;
            }
            if (option.isFilePath) {
                value = resolvePath(value);
            }
            options[name] = value;
        }
        else {
            error("Unknown config property '" + name + "'");
            return;
        }
    }
    function error(message) {
        result.diagnostics.push({
            fileName: null,
            start: null,
            length: null,
            line: null,
            character: null,
            category: _compiler.DiagnosticCategory.Error,
            code: 9999,
            message: message,
            next: null
        });
    }
}
function resolvePath(path) {
    return _path.normalize(_path.resolve(process.cwd(), path));
}
module.exports = plugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1haW4udHMiXSwibmFtZXMiOlsicGx1Z2luIiwiZmluZEZpbGVzIiwiZmluZEZpbGVzLnVuaXF1ZSIsImxvYWRBZGFwdGVyIiwicGFyc2VPcHRpb25zIiwicGFyc2VPcHRpb25zLnZhbGlkYXRlIiwicGFyc2VPcHRpb25zLmVycm9yIiwicmVzb2x2ZVBhdGgiXSwibWFwcGluZ3MiOiJBQUFBLDRDQUE0QztBQUc1QyxJQUFPLEtBQUssV0FBVyxNQUFNLENBQUMsQ0FBQztBQUMvQixJQUFPLEtBQUssV0FBVyxNQUFNLENBQUMsQ0FBQztBQUMvQixJQUFPLEtBQUssV0FBVyxRQUFRLENBQUMsQ0FBQztBQUNqQyxJQUFPLFNBQVMsV0FBVyxZQUFZLENBQUMsQ0FBQztBQUN6QyxJQUFPLFFBQVEsV0FBVyxXQUFXLENBQUMsQ0FBQztBQUN2QyxJQUFPLEtBQUssV0FBVyxRQUFRLENBQUMsQ0FBQztBQUVqQyxJQUFNLFlBQVksR0FBRyxZQUFZLENBQUM7QUFFbEMsZ0JBQWdCLE1BQWMsRUFBRSxLQUF3QjtJQUNwREEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsU0FBU0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0E7SUFFcENBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLFFBQVFBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQzFCQSxNQUFNQSxJQUFJQSxLQUFLQSxDQUFDQSxXQUFXQSxDQUFDQSxzQ0FBc0NBLENBQUNBLENBQUNBO0lBQ3hFQSxDQUFDQTtJQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN6QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FB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ZC50c1wiIC8+XG5cbmltcG9ydCBfZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IF9wYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IF9nbG9iID0gcmVxdWlyZSgnZ2xvYicpO1xuaW1wb3J0IF91dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XG5pbXBvcnQgX2NvbXBpbGVyID0gcmVxdWlyZSgnLi9jb21waWxlcicpO1xuaW1wb3J0IF9hZGFwdGVyID0gcmVxdWlyZSgnLi9hZGFwdGVyJyk7XG5pbXBvcnQgX2xhbmcgPSByZXF1aXJlKCcuL2xhbmcnKTtcblxuY29uc3QgU19UWVBFU0NSSVBUID0gJ3R5cGVzY3JpcHQnO1xuXG5mdW5jdGlvbiBwbHVnaW4oY29uZmlnOiBPYmplY3QsIGdsb2JzOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgIGxldCByZXN1bHQgPSBuZXcgX2NvbXBpbGVyLlJlc3VsdCgpO1xuXG4gICAgaWYgKCFfbGFuZy5pc09iamVjdChjb25maWcpKSB7XG4gICAgICAgIHRocm93IG5ldyBfdXRpbC5QbHVnaW5FcnJvcihgVGhlIGNvbmZpZyBhcmd1bWVudCBpcyBub3QgYW4gb2JqZWN0YCk7XG4gICAgfVxuICAgIGlmICghX2xhbmcuaXNTdHJpbmcoZ2xvYnMpKSB7XG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShnbG9icykgfHwgIWdsb2JzLmV2ZXJ5KF9sYW5nLmlzU3RyaW5nKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IF91dGlsLlBsdWdpbkVycm9yKGBUaGUgZ2xvYnMgYXJndW1lbnQgaXMgbm90IGEgc3RyaW5nIG9yIGFycmF5IG9mIHN0cmluZ3NgKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgZ2xvYnMgPSBbPHN0cmluZz5nbG9ic107XG4gICAgfVxuXG4gICAgbGV0IGZpbGVOYW1lcyA9IGZpbmRGaWxlcyg8c3RyaW5nW10+Z2xvYnMpO1xuICAgIGlmICghZmlsZU5hbWVzLmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgX3V0aWwuUGx1Z2luRXJyb3IoYFRoZSBtYXRjaGVkIGZpbGUgc2V0IGlzIGVtcHR5YCk7XG4gICAgfVxuXG4gICAgbGV0IGFkYXB0ZXIgPSBsb2FkQWRhcHRlcihjb25maWcpO1xuICAgIGxldCBvcHRpb25zID0gcGFyc2VPcHRpb25zKGFkYXB0ZXIub3B0aW9ucygpLCBjb25maWcsIHJlc3VsdCk7XG4gICAgaWYgKHJlc3VsdC5kaWFnbm9zdGljcy5sZW5ndGgpIHtcbiAgICAgICAgcmVzdWx0LnJlcG9ydERpYWdub3N0aWNzKCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBhZGFwdGVyLmNvbXBpbGUob3B0aW9ucywgZmlsZU5hbWVzLCByZXN1bHQpO1xuICAgICAgICBpZiAocmVzdWx0LmRpYWdub3N0aWNzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmVzdWx0LnJlcG9ydERpYWdub3N0aWNzKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBmaW5kRmlsZXMoZ2xvYnM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgIGxldCBmaWxlTmFtZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGxldCBnbG9iIG9mIGdsb2JzKSB7XG4gICAgICAgIGZpbGVOYW1lcyA9IGZpbGVOYW1lcy5jb25jYXQoX2dsb2Iuc3luYyhnbG9iLCB7IG5vZGlyOiB0cnVlIH0pKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmlsZU5hbWVzLm1hcChyZXNvbHZlUGF0aCkuZmlsdGVyKHVuaXF1ZSk7XG5cbiAgICBmdW5jdGlvbiB1bmlxdWU8VD4odmFsdWU6IFQsIGluZGV4OiBudW1iZXIsIGFycmF5OiBUW10pIHtcbiAgICAgICAgcmV0dXJuIGFycmF5LmluZGV4T2YodmFsdWUpID09PSBpbmRleDtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGxvYWRBZGFwdGVyKGNvbmZpZzogT2JqZWN0KTogX2NvbXBpbGVyLkNvbXBpbGVyIHtcbiAgICBpZiAoU19UWVBFU0NSSVBUIGluIGNvbmZpZykge1xuICAgICAgICByZXR1cm4gX2FkYXB0ZXIubG9hZChjb25maWdbU19UWVBFU0NSSVBUXSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gX2FkYXB0ZXIubG9hZChyZXF1aXJlKCd0eXBlc2NyaXB0JykpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VPcHRpb25zKG9wdGlvbnNMaXN0OiBfY29tcGlsZXIuT3B0aW9uW10sXG4gICAgICAgICAgICAgICAgICAgICAgY29uZmlnOiBPYmplY3QsXG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KTogT2JqZWN0IHtcbiAgICBsZXQgb3B0aW9ucyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgICBsZXQgb3B0aW9uc01hcCA9IF9sYW5nLmdyb3VwQnkob3B0aW9uc0xpc3QsICduYW1lJyk7XG5cbiAgICBfbGFuZy5mb3JFYWNoKGNvbmZpZywgdmFsaWRhdGUpO1xuXG4gICAgaWYgKG9wdGlvbnMucm9vdERpciA9PSBudWxsKSB7XG4gICAgICAgIG9wdGlvbnMucm9vdERpciA9IHJlc29sdmVQYXRoKCcuJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9wdGlvbnM7XG5cbiAgICBmdW5jdGlvbiB2YWxpZGF0ZShuYW1lLCB2YWx1ZSkge1xuICAgICAgICBpZiAobmFtZSA9PT0gU19UWVBFU0NSSVBUKSB7XG4gICAgICAgICAgICAvLyBJZ25vcmUuXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAobmFtZSBpbiBvcHRpb25zTWFwKSB7XG4gICAgICAgICAgICBsZXQgb3B0aW9uID0gb3B0aW9uc01hcFtuYW1lXTtcbiAgICAgICAgICAgIHN3aXRjaCAob3B0aW9uLnR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICAgICAgICBpZiAoIV9sYW5nLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoYEV4cGVjdGVkIHN0cmluZyB2YWx1ZSBvZiB0aGUgY29uZmlnIHByb3BlcnR5ICcke25hbWV9J2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgICAgICAgICAgICAgIGlmICghX2xhbmcuaXNOdW1iZXIodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihgRXhwZWN0ZWQgbnVtYmVyIHZhbHVlIG9mIHRoZSBjb25maWcgcHJvcGVydHkgJyR7bmFtZX0nYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XG4gICAgICAgICAgICAgICAgICAgIGlmICghX2xhbmcuaXNCb29sZWFuKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoYEV4cGVjdGVkIGJvb2xlYW4gdmFsdWUgb2YgdGhlIGNvbmZpZyBwcm9wZXJ0eSAnJHtuYW1lfSdgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgaW4gPGFueT5vcHRpb24udHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBvcHRpb24udHlwZVt2YWx1ZV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihgVW5rbm93biB2YWx1ZSAnJHt2YWx1ZX0nIG9mIHRoZSBjb25maWcgcHJvcGVydHkgJyR7bmFtZX0nLCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgZXhwZWN0ZWQgb25lIG9mICR7T2JqZWN0LmtleXMob3B0aW9uLnR5cGUpLm1hcChzID0+IGAnJHtzfSdgKS5qb2luKCcsICcpfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob3B0aW9uLmlzRmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlc29sdmVQYXRoKHZhbHVlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgb3B0aW9uc1tuYW1lXSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgZXJyb3IoYFVua25vd24gY29uZmlnIHByb3BlcnR5ICcke25hbWV9J2ApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZXJyb3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgICAgIHJlc3VsdC5kaWFnbm9zdGljcy5wdXNoKHtcbiAgICAgICAgICAgIGZpbGVOYW1lOiBudWxsLFxuICAgICAgICAgICAgc3RhcnQ6IG51bGwsXG4gICAgICAgICAgICBsZW5ndGg6IG51bGwsXG4gICAgICAgICAgICBsaW5lOiBudWxsLFxuICAgICAgICAgICAgY2hhcmFjdGVyOiBudWxsLFxuICAgICAgICAgICAgY2F0ZWdvcnk6IF9jb21waWxlci5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3IsXG4gICAgICAgICAgICBjb2RlOiA5OTk5LFxuICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgICAgIG5leHQ6IG51bGxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiByZXNvbHZlUGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBfcGF0aC5ub3JtYWxpemUoX3BhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBwYXRoKSk7XG59XG5cbmV4cG9ydCA9IHBsdWdpbjtcbiJdfQ==