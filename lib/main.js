/// <reference path="../typings/tsd.d.ts" />
var _path = require('path');
var _glob = require('glob');
var _util = require('./util');
var _compiler = require('./compiler');
var _adapter = require('./adapter');
var _lang = require('./lang');
var S_TYPESCRIPT = 'typescript';
function plugin(config, globs) {
    var output = new _compiler.Output();
    if (!_lang.isObject(config)) {
        throw new _util.PluginError("The config argument is not an object");
    }
    if (!_lang.isString(globs)) {
        if (!Array.isArray(globs)) {
            throw new _util.PluginError("The globs argument is not a string or array of strings");
        }
    }
    else {
        globs = [globs];
    }
    var fileNames = findFiles(globs);
    if (!fileNames.length) {
        throw new _util.PluginError("The matched file set is empty");
    }
    var adapter = loadAdapter(config);
    var options = parseOptions(adapter.options(), config, output);
    if (output.diagnostics.length) {
        output.reportDiagnostics();
    }
    else {
        adapter.compile(options, fileNames, output);
        if (output.diagnostics.length) {
            output.reportDiagnostics();
        }
    }
    return output;
}
function findFiles(globs) {
    var fileNames = [];
    for (var _i = 0; _i < globs.length; _i++) {
        var glob = globs[_i];
        fileNames = fileNames.concat(_glob.sync(glob, { nodir: true }));
    }
    return fileNames.map(resolvePath).filter(unique);
    function unique(value, index, array) {
        return array.indexOf(value) === index;
    }
}
function loadAdapter(config) {
    if (S_TYPESCRIPT in config) {
        return _adapter.load(config[S_TYPESCRIPT]);
    }
    else {
        return _adapter.load(require('typescript'));
    }
}
function parseOptions(optionsList, config, output) {
    var result = Object.create(null);
    var optionsMap = _lang.groupBy(optionsList, 'name');
    _lang.forEach(config, validate);
    if (result.rootDir == null) {
        result.rootDir = resolvePath('.');
    }
    return result;
    function validate(name, value) {
        if (name === S_TYPESCRIPT) {
        }
        else if (name in optionsMap) {
            var option = optionsMap[name];
            switch (option.type) {
                case 'string':
                    if (!_lang.isString(value)) {
                        error("Expected string value of the config property '" + name + "'");
                        return;
                    }
                    break;
                case 'number':
                    if (!_lang.isNumber(value)) {
                        error("Expected number value of the config property '" + name + "'");
                        return;
                    }
                    break;
                case 'boolean':
                    if (!_lang.isBoolean(value)) {
                        error("Expected boolean value of the config property '" + name + "'");
                        return;
                    }
                    break;
                default:
                    if (value in option.type) {
                        value = option.type[value];
                    }
                    else {
                        error(("Unknown value '" + value + "' of the config property '" + name + "', ") +
                            ("expected one of " + Object.keys(option.type).map(function (s) { return ("'" + s + "'"); }).join(', ')));
                        return;
                    }
                    break;
            }
            if (option.isFilePath) {
                value = resolvePath(value);
            }
            result[name] = value;
        }
        else {
            error("Unknown config property '" + name + "'");
            return;
        }
    }
    function error(message) {
        output.diagnostics.push({
            fileName: null,
            start: null,
            length: null,
            line: null,
            character: null,
            category: _compiler.DiagnosticCategory.Error,
            code: 9999,
            message: message,
            next: null
        });
    }
}
function resolvePath(path) {
    return _path.normalize(_path.resolve(process.cwd(), path));
}
module.exports = plugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1haW4udHMiXSwibmFtZXMiOlsicGx1Z2luIiwiZmluZEZpbGVzIiwiZmluZEZpbGVzLnVuaXF1ZSIsImxvYWRBZGFwdGVyIiwicGFyc2VPcHRpb25zIiwicGFyc2VPcHRpb25zLnZhbGlkYXRlIiwicGFyc2VPcHRpb25zLmVycm9yIiwicmVzb2x2ZVBhdGgiXSwibWFwcGluZ3MiOiJBQUFBLDRDQUE0QztBQUc1QyxJQUFPLEtBQUssV0FBVyxNQUFNLENBQUMsQ0FBQztBQUMvQixJQUFPLEtBQUssV0FBVyxNQUFNLENBQUMsQ0FBQztBQUMvQixJQUFPLEtBQUssV0FBVyxRQUFRLENBQUMsQ0FBQztBQUNqQyxJQUFPLFNBQVMsV0FBVyxZQUFZLENBQUMsQ0FBQztBQUN6QyxJQUFPLFFBQVEsV0FBVyxXQUFXLENBQUMsQ0FBQztBQUN2QyxJQUFPLEtBQUssV0FBVyxRQUFRLENBQUMsQ0FBQztBQUVqQyxJQUFNLFlBQVksR0FBRyxZQUFZLENBQUM7QUFFbEMsZ0JBQWdCLE1BQWMsRUFBRSxLQUF3QjtJQUNwREEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsU0FBU0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0E7SUFFcENBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLFFBQVFBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQzFCQSxNQUFNQSxJQUFJQSxLQUFLQSxDQUFDQSxXQUFXQSxDQUFDQSxzQ0FBc0NBLENBQUNBLENBQUNBO0lBQ3hFQSxDQUFDQTtJQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN6QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFD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QVVBLENBQUNBLENBQUNBLENBQUNBO2dCQUNwQkEsS0FBS0EsR0FBR0EsV0FBV0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7WUFDL0JBLENBQUNBO1lBRURBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLEtBQUtBLENBQUNBO1FBQ3pCQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNGQSxLQUFLQSxDQUFDQSw4QkFBNEJBLElBQUlBLE1BQUdBLENBQUNBLENBQUNBO1lBQzNDQSxNQUFNQSxDQUFDQTtRQUNYQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVERCxlQUFlQSxPQUFlQTtRQUMxQkUsTUFBTUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0E7WUFDcEJBLFFBQVFBLEVBQUVBLElBQUlBO1lBQ2RBLEtBQUtBLEVBQUVBLElBQUlBO1lBQ1hBLE1BQU1BLEVBQUVBLElBQUlBO1lBQ1pBLElBQUlBLEVBQUVBLElBQUlBO1lBQ1ZBLFNBQVNBLEVBQUVBLElBQUlBO1lBQ2ZBLFFBQVFBLEVBQUVBLFNBQVNBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsS0FBS0E7WUFDNUNBLElBQUlBLEVBQUVBLElBQUlBO1lBQ1ZBLE9BQU9BLEVBQUVBLE9BQU9BO1lBQ2hCQSxJQUFJQSxFQUFFQSxJQUFJQTtTQUNiQSxDQUFDQSxDQUFDQTtJQUNQQSxDQUFDQTtBQUNMRixDQUFDQTtBQUVELHFCQUFxQixJQUFZO0lBQzdCRyxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxTQUFTQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxFQUFFQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtBQUMvREEsQ0FBQ0E7QUFFRCxpQkFBUyxNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy90c2QuZC50c1wiIC8+XG5cbmltcG9ydCBfZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IF9wYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IF9nbG9iID0gcmVxdWlyZSgnZ2xvYicpO1xuaW1wb3J0IF91dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XG5pbXBvcnQgX2NvbXBpbGVyID0gcmVxdWlyZSgnLi9jb21waWxlcicpO1xuaW1wb3J0IF9hZGFwdGVyID0gcmVxdWlyZSgnLi9hZGFwdGVyJyk7XG5pbXBvcnQgX2xhbmcgPSByZXF1aXJlKCcuL2xhbmcnKTtcblxuY29uc3QgU19UWVBFU0NSSVBUID0gJ3R5cGVzY3JpcHQnO1xuXG5mdW5jdGlvbiBwbHVnaW4oY29uZmlnOiBPYmplY3QsIGdsb2JzOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgIGxldCBvdXRwdXQgPSBuZXcgX2NvbXBpbGVyLk91dHB1dCgpO1xuXG4gICAgaWYgKCFfbGFuZy5pc09iamVjdChjb25maWcpKSB7XG4gICAgICAgIHRocm93IG5ldyBfdXRpbC5QbHVnaW5FcnJvcihgVGhlIGNvbmZpZyBhcmd1bWVudCBpcyBub3QgYW4gb2JqZWN0YCk7XG4gICAgfVxuICAgIGlmICghX2xhbmcuaXNTdHJpbmcoZ2xvYnMpKSB7XG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShnbG9icykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBfdXRpbC5QbHVnaW5FcnJvcihgVGhlIGdsb2JzIGFyZ3VtZW50IGlzIG5vdCBhIHN0cmluZyBvciBhcnJheSBvZiBzdHJpbmdzYCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGdsb2JzID0gWzxzdHJpbmc+Z2xvYnNdO1xuICAgIH1cblxuICAgIGxldCBmaWxlTmFtZXMgPSBmaW5kRmlsZXMoPHN0cmluZ1tdPmdsb2JzKTtcbiAgICBpZiAoIWZpbGVOYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IF91dGlsLlBsdWdpbkVycm9yKGBUaGUgbWF0Y2hlZCBmaWxlIHNldCBpcyBlbXB0eWApO1xuICAgIH1cblxuICAgIGxldCBhZGFwdGVyID0gbG9hZEFkYXB0ZXIoY29uZmlnKTtcbiAgICBsZXQgb3B0aW9ucyA9IHBhcnNlT3B0aW9ucyhhZGFwdGVyLm9wdGlvbnMoKSwgY29uZmlnLCBvdXRwdXQpO1xuICAgIGlmIChvdXRwdXQuZGlhZ25vc3RpY3MubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5yZXBvcnREaWFnbm9zdGljcygpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgYWRhcHRlci5jb21waWxlKG9wdGlvbnMsIGZpbGVOYW1lcywgb3V0cHV0KTtcbiAgICAgICAgaWYgKG91dHB1dC5kaWFnbm9zdGljcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIG91dHB1dC5yZXBvcnREaWFnbm9zdGljcygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dHB1dDtcbn1cblxuZnVuY3Rpb24gZmluZEZpbGVzKGdsb2JzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgICBsZXQgZmlsZU5hbWVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgZ2xvYiBvZiBnbG9icykge1xuICAgICAgICBmaWxlTmFtZXMgPSBmaWxlTmFtZXMuY29uY2F0KF9nbG9iLnN5bmMoZ2xvYiwgeyBub2RpcjogdHJ1ZSB9KSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbGVOYW1lcy5tYXAocmVzb2x2ZVBhdGgpLmZpbHRlcih1bmlxdWUpO1xuXG4gICAgZnVuY3Rpb24gdW5pcXVlPFQ+KHZhbHVlOiBULCBpbmRleDogbnVtYmVyLCBhcnJheTogVFtdKSB7XG4gICAgICAgIHJldHVybiBhcnJheS5pbmRleE9mKHZhbHVlKSA9PT0gaW5kZXg7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBsb2FkQWRhcHRlcihjb25maWc6IE9iamVjdCk6IF9jb21waWxlci5Db21waWxlciB7XG4gICAgaWYgKFNfVFlQRVNDUklQVCBpbiBjb25maWcpIHtcbiAgICAgICAgcmV0dXJuIF9hZGFwdGVyLmxvYWQoY29uZmlnW1NfVFlQRVNDUklQVF0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIF9hZGFwdGVyLmxvYWQocmVxdWlyZSgndHlwZXNjcmlwdCcpKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlT3B0aW9ucyhvcHRpb25zTGlzdDogX2NvbXBpbGVyLk9wdGlvbltdLFxuICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZzogT2JqZWN0LFxuICAgICAgICAgICAgICAgICAgICAgIG91dHB1dDogX2NvbXBpbGVyLk91dHB1dCk6IE9iamVjdCB7XG4gICAgbGV0IHJlc3VsdCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgICBsZXQgb3B0aW9uc01hcCA9IF9sYW5nLmdyb3VwQnkob3B0aW9uc0xpc3QsICduYW1lJyk7XG5cbiAgICBfbGFuZy5mb3JFYWNoKGNvbmZpZywgdmFsaWRhdGUpO1xuXG4gICAgaWYgKHJlc3VsdC5yb290RGlyID09IG51bGwpIHtcbiAgICAgICAgcmVzdWx0LnJvb3REaXIgPSByZXNvbHZlUGF0aCgnLicpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICBmdW5jdGlvbiB2YWxpZGF0ZShuYW1lLCB2YWx1ZSkge1xuICAgICAgICBpZiAobmFtZSA9PT0gU19UWVBFU0NSSVBUKSB7XG4gICAgICAgICAgICAvLyBJZ25vcmUuXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAobmFtZSBpbiBvcHRpb25zTWFwKSB7XG4gICAgICAgICAgICBsZXQgb3B0aW9uID0gb3B0aW9uc01hcFtuYW1lXTtcbiAgICAgICAgICAgIHN3aXRjaCAob3B0aW9uLnR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICAgICAgICBpZiAoIV9sYW5nLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoYEV4cGVjdGVkIHN0cmluZyB2YWx1ZSBvZiB0aGUgY29uZmlnIHByb3BlcnR5ICcke25hbWV9J2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgICAgICAgICAgICAgIGlmICghX2xhbmcuaXNOdW1iZXIodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihgRXhwZWN0ZWQgbnVtYmVyIHZhbHVlIG9mIHRoZSBjb25maWcgcHJvcGVydHkgJyR7bmFtZX0nYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XG4gICAgICAgICAgICAgICAgICAgIGlmICghX2xhbmcuaXNCb29sZWFuKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoYEV4cGVjdGVkIGJvb2xlYW4gdmFsdWUgb2YgdGhlIGNvbmZpZyBwcm9wZXJ0eSAnJHtuYW1lfSdgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgaW4gPGFueT5vcHRpb24udHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBvcHRpb24udHlwZVt2YWx1ZV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcihgVW5rbm93biB2YWx1ZSAnJHt2YWx1ZX0nIG9mIHRoZSBjb25maWcgcHJvcGVydHkgJyR7bmFtZX0nLCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgZXhwZWN0ZWQgb25lIG9mICR7T2JqZWN0LmtleXMob3B0aW9uLnR5cGUpLm1hcChzID0+IGAnJHtzfSdgKS5qb2luKCcsICcpfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAob3B0aW9uLmlzRmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlc29sdmVQYXRoKHZhbHVlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVzdWx0W25hbWVdID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBlcnJvcihgVW5rbm93biBjb25maWcgcHJvcGVydHkgJyR7bmFtZX0nYCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBlcnJvcihtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICAgICAgb3V0cHV0LmRpYWdub3N0aWNzLnB1c2goe1xuICAgICAgICAgICAgZmlsZU5hbWU6IG51bGwsXG4gICAgICAgICAgICBzdGFydDogbnVsbCxcbiAgICAgICAgICAgIGxlbmd0aDogbnVsbCxcbiAgICAgICAgICAgIGxpbmU6IG51bGwsXG4gICAgICAgICAgICBjaGFyYWN0ZXI6IG51bGwsXG4gICAgICAgICAgICBjYXRlZ29yeTogX2NvbXBpbGVyLkRpYWdub3N0aWNDYXRlZ29yeS5FcnJvcixcbiAgICAgICAgICAgIGNvZGU6IDk5OTksXG4gICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgICAgICAgbmV4dDogbnVsbFxuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlc29sdmVQYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIF9wYXRoLm5vcm1hbGl6ZShfcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIHBhdGgpKTtcbn1cblxuZXhwb3J0ID0gcGx1Z2luO1xuIl19