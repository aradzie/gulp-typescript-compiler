var _fs = require('fs');
var _path = require('path');
var _gu = require('gulp-util');
var _util = require('./util');
var Result = (function () {
    function Result() {
        this.emitSkipped = false;
        this.diagnostics = [];
        this.scripts = [];
        this.sourceMaps = [];
        this.declarations = [];
    }
    Result.prototype.reportDiagnostics = function () {
        var messages = [];
        if (this.emitSkipped) {
            messages.push('TypeScript compiler: ' + _gu.colors.red('emit skipped'));
        }
        else if (this.diagnostics.length) {
            messages.push('TypeScript compiler: ' + _gu.colors.red('emit completed with errors'));
        }
        for (var _i = 0, _a = this.diagnostics; _i < _a.length; _i++) {
            var d = _a[_i];
            messages.push(format(d));
        }
        if (messages.length) {
            _gu.log(messages.join('\n'));
        }
        function format(d) {
            var category = (_a = {},
                _a[DiagnosticCategory.Warning] = 'warning',
                _a[DiagnosticCategory.Error] = 'error',
                _a[DiagnosticCategory.Message] = 'message',
                _a
            );
            var output = '';
            if (d.fileName) {
                output += _path.relative(process.cwd(), d.fileName) + "(" + (d.line + 1) + "," + (d.character + 1) + "): ";
            }
            output += category[d.category] + " TS" + d.code + ": " + d.message;
            var level = 1;
            var next = d.next;
            while (next) {
                output += '\n';
                for (var i = 0; i < level; i++) {
                    output += '  ';
                }
                output += next.message;
                level++;
                next = next.next;
            }
            return output;
            var _a;
        }
    };
    Result.prototype._create = function (base, path, data) {
        var file = new _gu.File({
            base: base,
            path: path,
            contents: new Buffer(data)
        });
        var _a = findExt(path), basename = _a.basename, ext = _a.ext;
        switch (ext) {
            case '.js':
            case '.jsx':
                this.scripts.push(file);
                break;
            case '.js.map':
            case '.jsx.map':
                this.sourceMaps.push(file);
                break;
            case '.d.ts':
                this.declarations.push(file);
                break;
            default:
                throw new Error("Unknown extension of file '" + path + "'");
        }
        function findExt(path) {
            var suffixes = ['.js', '.jsx', '.js.map', '.jsx.map', '.d.ts'];
            for (var _i = 0; _i < suffixes.length; _i++) {
                var suffix = suffixes[_i];
                if (path.toLowerCase().endsWith(suffix)) {
                    return {
                        basename: path.substring(0, path.length - suffix.length),
                        ext: suffix
                    };
                }
            }
            return {
                basename: path,
                ext: null
            };
        }
    };
    Result.prototype.emit = function () {
        return new _util.PassThroughStream([].concat(this.scripts, this.sourceMaps, this.declarations));
    };
    Result.prototype.emitScripts = function () {
        return new _util.PassThroughStream(this.scripts);
    };
    Result.prototype.emitSourceMaps = function () {
        return new _util.PassThroughStream(this.sourceMaps);
    };
    Result.prototype.emitDeclarations = function () {
        return new _util.PassThroughStream(this.declarations);
    };
    Result.prototype.writeFiles = function () {
        var files = [].concat(this.scripts, this.sourceMaps, this.declarations);
        for (var _i = 0; _i < files.length; _i++) {
            var file = files[_i];
            mkdirpSync(_path.dirname(file.path));
            _fs.writeFileSync(file.path, file.contents, { encoding: 'UTF-8' });
        }
        function mkdirpSync(path) {
            try {
                var stats = _fs.lstatSync(path);
            }
            catch (ex) { }
            if (!stats || !stats.isDirectory()) {
                mkdirpSync(_path.dirname(path));
                _fs.mkdirSync(path);
            }
        }
    };
    return Result;
})();
exports.Result = Result;
(function (DiagnosticCategory) {
    DiagnosticCategory[DiagnosticCategory["Warning"] = 0] = "Warning";
    DiagnosticCategory[DiagnosticCategory["Error"] = 1] = "Error";
    DiagnosticCategory[DiagnosticCategory["Message"] = 2] = "Message";
})(exports.DiagnosticCategory || (exports.DiagnosticCategory = {}));
var DiagnosticCategory = exports.DiagnosticCategory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb21waWxlci50cyJdLCJuYW1lcyI6WyJSZXN1bHQiLCJSZXN1bHQuY29uc3RydWN0b3IiLCJSZXN1bHQucmVwb3J0RGlhZ25vc3RpY3MiLCJSZXN1bHQucmVwb3J0RGlhZ25vc3RpY3MuZm9ybWF0IiwiUmVzdWx0Ll9jcmVhdGUiLCJSZXN1bHQuX2NyZWF0ZS5maW5kRXh0IiwiUmVzdWx0LmVtaXQiLCJSZXN1bHQuZW1pdFNjcmlwdHMiLCJSZXN1bHQuZW1pdFNvdXJjZU1hcHMiLCJSZXN1bHQuZW1pdERlY2xhcmF0aW9ucyIsIlJlc3VsdC53cml0ZUZpbGVzIiwiUmVzdWx0LndyaXRlRmlsZXMubWtkaXJwU3luYyIsIkRpYWdub3N0aWNDYXRlZ29yeSJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBTyxHQUFHLFdBQVcsSUFBSSxDQUFDLENBQUM7QUFDM0IsSUFBTyxLQUFLLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFDL0IsSUFBTyxHQUFHLFdBQVcsV0FBVyxDQUFDLENBQUM7QUFDbEMsSUFBTyxLQUFLLFdBQVcsUUFBUSxDQUFDLENBQUM7QUFjakM7SUFBQUE7UUFDSUMsZ0JBQVdBLEdBQVlBLEtBQUtBLENBQUNBO1FBQzdCQSxnQkFBV0EsR0FBaUJBLEVBQUVBLENBQUNBO1FBQy9CQSxZQUFPQSxHQUFlQSxFQUFFQSxDQUFDQTtRQUN6QkEsZUFBVUEsR0FBZUEsRUFBRUEsQ0FBQ0E7UUFDNUJBLGlCQUFZQSxHQUFlQSxFQUFFQSxDQUFDQTtJQTBIbENBLENBQUNBO0lBeEhHRCxrQ0FBaUJBLEdBQWpCQTtRQUNJRSxJQUFJQSxRQUFRQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUVsQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbkJBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLHVCQUF1QkEsR0FBR0EsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FB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QURBLENBQUNBLEFBL0hELElBK0hDO0FBL0hZLGNBQU0sU0ErSGxCLENBQUE7QUFFRCxXQUFZLGtCQUFrQjtJQUMxQlksaUVBQVdBLENBQUFBO0lBQ1hBLDZEQUFTQSxDQUFBQTtJQUNUQSxpRUFBV0EsQ0FBQUE7QUFDZkEsQ0FBQ0EsRUFKVywwQkFBa0IsS0FBbEIsMEJBQWtCLFFBSTdCO0FBSkQsSUFBWSxrQkFBa0IsR0FBbEIsMEJBSVgsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IF9wYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IF9ndSA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpO1xuaW1wb3J0IF91dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XG5pbXBvcnQgX2xhbmcgPSByZXF1aXJlKCcuL2xhbmcnKTtcblxuZXhwb3J0IGludGVyZmFjZSBPcHRpb24ge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0eXBlOiBzdHJpbmcgfCBfbGFuZy5NYXA8bnVtYmVyPjtcbiAgICBpc0ZpbGVQYXRoPzogYm9vbGVhbjtcbiAgICBleHBlcmltZW50YWw/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbXBpbGVyIHtcbiAgICBjb21waWxlKG9wdGlvbnM6IGFueSwgZmlsZU5hbWVzOiBzdHJpbmdbXSwgcmVzdWx0OiBSZXN1bHQpO1xufVxuXG5leHBvcnQgY2xhc3MgUmVzdWx0IHtcbiAgICBlbWl0U2tpcHBlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIGRpYWdub3N0aWNzOiBEaWFnbm9zdGljW10gPSBbXTtcbiAgICBzY3JpcHRzOiBfZ3UuRmlsZVtdID0gW107XG4gICAgc291cmNlTWFwczogX2d1LkZpbGVbXSA9IFtdO1xuICAgIGRlY2xhcmF0aW9uczogX2d1LkZpbGVbXSA9IFtdO1xuXG4gICAgcmVwb3J0RGlhZ25vc3RpY3MoKSB7XG4gICAgICAgIGxldCBtZXNzYWdlcyA9IFtdO1xuXG4gICAgICAgIGlmICh0aGlzLmVtaXRTa2lwcGVkKSB7XG4gICAgICAgICAgICBtZXNzYWdlcy5wdXNoKCdUeXBlU2NyaXB0IGNvbXBpbGVyOiAnICsgX2d1LmNvbG9ycy5yZWQoJ2VtaXQgc2tpcHBlZCcpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0aGlzLmRpYWdub3N0aWNzLmxlbmd0aCkge1xuICAgICAgICAgICAgbWVzc2FnZXMucHVzaCgnVHlwZVNjcmlwdCBjb21waWxlcjogJyArIF9ndS5jb2xvcnMucmVkKCdlbWl0IGNvbXBsZXRlZCB3aXRoIGVycm9ycycpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGQgb2YgdGhpcy5kaWFnbm9zdGljcykge1xuICAgICAgICAgICAgbWVzc2FnZXMucHVzaChmb3JtYXQoZCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG1lc3NhZ2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgX2d1LmxvZyhtZXNzYWdlcy5qb2luKCdcXG4nKSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBmb3JtYXQoZDogRGlhZ25vc3RpYyk6IHN0cmluZyB7XG4gICAgICAgICAgICBsZXQgY2F0ZWdvcnkgPSB7XG4gICAgICAgICAgICAgICAgW0RpYWdub3N0aWNDYXRlZ29yeS5XYXJuaW5nXTogJ3dhcm5pbmcnLFxuICAgICAgICAgICAgICAgIFtEaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3JdOiAnZXJyb3InLFxuICAgICAgICAgICAgICAgIFtEaWFnbm9zdGljQ2F0ZWdvcnkuTWVzc2FnZV06ICdtZXNzYWdlJyxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBsZXQgb3V0cHV0ID0gJyc7XG4gICAgICAgICAgICBpZiAoZC5maWxlTmFtZSkge1xuICAgICAgICAgICAgICAgIG91dHB1dCArPSBgJHtfcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBkLmZpbGVOYW1lKX0oJHtkLmxpbmUgKyAxfSwke2QuY2hhcmFjdGVyICsgMX0pOiBgO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb3V0cHV0ICs9IGAke2NhdGVnb3J5W2QuY2F0ZWdvcnldfSBUUyR7ZC5jb2RlfTogJHtkLm1lc3NhZ2V9YDtcbiAgICAgICAgICAgIGxldCBsZXZlbCA9IDE7XG4gICAgICAgICAgICBsZXQgbmV4dCA9IGQubmV4dDtcbiAgICAgICAgICAgIHdoaWxlIChuZXh0KSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0ICs9ICdcXG4nO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGV2ZWw7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBvdXRwdXQgKz0gJyAgJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb3V0cHV0ICs9IG5leHQubWVzc2FnZTtcbiAgICAgICAgICAgICAgICBsZXZlbCsrO1xuICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0Lm5leHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb3V0cHV0O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2NyZWF0ZShiYXNlOiBzdHJpbmcsIHBhdGg6IHN0cmluZywgZGF0YTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGxldCBmaWxlID0gbmV3IF9ndS5GaWxlKHtcbiAgICAgICAgICAgIGJhc2U6IGJhc2UsXG4gICAgICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICAgICAgY29udGVudHM6IG5ldyBCdWZmZXIoZGF0YSlcbiAgICAgICAgfSk7XG4gICAgICAgIGxldCB7IGJhc2VuYW1lLCBleHQgfSA9IGZpbmRFeHQocGF0aCk7XG4gICAgICAgIHN3aXRjaCAoZXh0KSB7XG4gICAgICAgICAgICBjYXNlICcuanMnOlxuICAgICAgICAgICAgY2FzZSAnLmpzeCc6XG4gICAgICAgICAgICAgICAgdGhpcy5zY3JpcHRzLnB1c2goZmlsZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICcuanMubWFwJzpcbiAgICAgICAgICAgIGNhc2UgJy5qc3gubWFwJzpcbiAgICAgICAgICAgICAgICB0aGlzLnNvdXJjZU1hcHMucHVzaChmaWxlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJy5kLnRzJzpcbiAgICAgICAgICAgICAgICB0aGlzLmRlY2xhcmF0aW9ucy5wdXNoKGZpbGUpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gZXh0ZW5zaW9uIG9mIGZpbGUgJyR7cGF0aH0nYCk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBmaW5kRXh0KHBhdGg6IHN0cmluZyk6IHsgYmFzZW5hbWU6IHN0cmluZzsgZXh0OiBzdHJpbmc7IH0ge1xuICAgICAgICAgICAgbGV0IHN1ZmZpeGVzID0gWycuanMnLCAnLmpzeCcsICcuanMubWFwJywgJy5qc3gubWFwJywgJy5kLnRzJ107XG4gICAgICAgICAgICBmb3IgKGxldCBzdWZmaXggb2Ygc3VmZml4ZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAocGF0aC50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKHN1ZmZpeCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2VuYW1lOiBwYXRoLnN1YnN0cmluZygwLCBwYXRoLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXh0OiBzdWZmaXhcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgYmFzZW5hbWU6IHBhdGgsXG4gICAgICAgICAgICAgICAgZXh0OiBudWxsXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBlbWl0KCkge1xuICAgICAgICByZXR1cm4gbmV3IF91dGlsLlBhc3NUaHJvdWdoU3RyZWFtKFxuICAgICAgICAgICAgW10uY29uY2F0KHRoaXMuc2NyaXB0cywgdGhpcy5zb3VyY2VNYXBzLCB0aGlzLmRlY2xhcmF0aW9ucylcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBlbWl0U2NyaXB0cygpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBfdXRpbC5QYXNzVGhyb3VnaFN0cmVhbSh0aGlzLnNjcmlwdHMpO1xuICAgIH1cblxuICAgIGVtaXRTb3VyY2VNYXBzKCkge1xuICAgICAgICByZXR1cm4gbmV3IF91dGlsLlBhc3NUaHJvdWdoU3RyZWFtKHRoaXMuc291cmNlTWFwcyk7XG4gICAgfVxuXG4gICAgZW1pdERlY2xhcmF0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBfdXRpbC5QYXNzVGhyb3VnaFN0cmVhbSh0aGlzLmRlY2xhcmF0aW9ucyk7XG4gICAgfVxuXG4gICAgd3JpdGVGaWxlcygpIHtcbiAgICAgICAgbGV0IGZpbGVzID0gW10uY29uY2F0KHRoaXMuc2NyaXB0cywgdGhpcy5zb3VyY2VNYXBzLCB0aGlzLmRlY2xhcmF0aW9ucyk7XG4gICAgICAgIGZvciAobGV0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgICAgIG1rZGlycFN5bmMoX3BhdGguZGlybmFtZShmaWxlLnBhdGgpKTtcbiAgICAgICAgICAgIF9mcy53cml0ZUZpbGVTeW5jKGZpbGUucGF0aCwgZmlsZS5jb250ZW50cywgeyBlbmNvZGluZzogJ1VURi04JyB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIG1rZGlycFN5bmMocGF0aDogc3RyaW5nKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHZhciBzdGF0cyA9IF9mcy5sc3RhdFN5bmMocGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXgpIHt9XG4gICAgICAgICAgICBpZiAoIXN0YXRzIHx8ICFzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgbWtkaXJwU3luYyhfcGF0aC5kaXJuYW1lKHBhdGgpKTtcbiAgICAgICAgICAgICAgICBfZnMubWtkaXJTeW5jKHBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZW51bSBEaWFnbm9zdGljQ2F0ZWdvcnkge1xuICAgIFdhcm5pbmcgPSAwLFxuICAgIEVycm9yID0gMSxcbiAgICBNZXNzYWdlID0gMixcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEaWFnbm9zdGljIGV4dGVuZHMgRGlhZ25vc3RpY0NoYWluIHtcbiAgICBmaWxlTmFtZTogc3RyaW5nO1xuICAgIHN0YXJ0OiBudW1iZXI7XG4gICAgbGVuZ3RoOiBudW1iZXI7XG4gICAgbGluZTogbnVtYmVyO1xuICAgIGNoYXJhY3RlcjogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERpYWdub3N0aWNDaGFpbiB7XG4gICAgY2F0ZWdvcnk6IERpYWdub3N0aWNDYXRlZ29yeTtcbiAgICBjb2RlOiBudW1iZXI7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIG5leHQ/OiBEaWFnbm9zdGljQ2hhaW47XG59XG4iXX0=