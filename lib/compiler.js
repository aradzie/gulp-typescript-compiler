var _fs = require('fs');
var _path = require('path');
var _gu = require('gulp-util');
var _util = require('./util');
var Output = (function () {
    function Output() {
        this.diagnostics = [];
        this.scripts = [];
        this.sourceMaps = [];
        this.declarations = [];
    }
    Output.prototype.reportDiagnostics = function () {
        if (this.diagnostics.length) {
            var messages = [String(_gu.colors.red('TypeScript compiler diagnostics:'))];
            for (var _i = 0, _a = this.diagnostics; _i < _a.length; _i++) {
                var d = _a[_i];
                messages.push(format(d));
            }
            _gu.log(messages.join('\n'));
        }
        function format(d) {
            var category = (_a = {},
                _a[DiagnosticCategory.Warning] = 'warning',
                _a[DiagnosticCategory.Error] = 'error',
                _a[DiagnosticCategory.Message] = 'message',
                _a
            );
            var output = '';
            if (d.fileName) {
                output += _path.relative(process.cwd(), d.fileName) + "(" + (d.line + 1) + "," + (d.character + 1) + "): ";
            }
            output += category[d.category] + " TS" + d.code + ": " + d.message;
            var level = 1;
            var next = d.next;
            while (next) {
                output += '\n';
                for (var i = 0; i < level; i++) {
                    output += '  ';
                }
                output += next.message;
                level++;
                next = next.next;
            }
            return output;
            var _a;
        }
    };
    Output.prototype.write = function (base, path, data) {
        var file = new _gu.File({
            base: base,
            path: path,
            contents: new Buffer(data)
        });
        var _a = findExt(path), basename = _a.basename, ext = _a.ext;
        switch (ext) {
            case '.js':
            case '.jsx':
                this.scripts.push(file);
                break;
            case '.js.map':
            case '.jsx.map':
                this.sourceMaps.push(file);
                break;
            case '.d.ts':
                this.declarations.push(file);
                break;
            default:
                throw new Error("Unknown extension of file '" + path + "'");
        }
        function findExt(path) {
            var suffixes = ['.js', '.jsx', '.js.map', '.jsx.map', '.d.ts'];
            for (var _i = 0; _i < suffixes.length; _i++) {
                var suffix = suffixes[_i];
                if (path.endsWith(suffix)) {
                    return {
                        basename: path.substring(0, path.length - suffix.length),
                        ext: suffix
                    };
                }
            }
            return {
                basename: path,
                ext: null
            };
        }
    };
    Output.prototype.emit = function () {
        return new _util.PassThroughStream([].concat(this.scripts, this.sourceMaps, this.declarations));
    };
    Output.prototype.emitScripts = function () {
        return new _util.PassThroughStream(this.scripts);
    };
    Output.prototype.emitSourceMaps = function () {
        return new _util.PassThroughStream(this.sourceMaps);
    };
    Output.prototype.emitDeclarations = function () {
        return new _util.PassThroughStream(this.declarations);
    };
    Output.prototype.writeFiles = function () {
        var files = [].concat(this.scripts, this.sourceMaps, this.declarations);
        for (var _i = 0; _i < files.length; _i++) {
            var file = files[_i];
            mkdirpSync(_path.dirname(file.path));
            _fs.writeFileSync(file.path, file.contents, { encoding: 'UTF-8' });
        }
        function mkdirpSync(path) {
            try {
                var stats = _fs.lstatSync(path);
            }
            catch (ex) { }
            if (!stats || !stats.isDirectory()) {
                mkdirpSync(_path.dirname(path));
                _fs.mkdirSync(path);
            }
        }
    };
    return Output;
})();
exports.Output = Output;
(function (DiagnosticCategory) {
    DiagnosticCategory[DiagnosticCategory["Warning"] = 0] = "Warning";
    DiagnosticCategory[DiagnosticCategory["Error"] = 1] = "Error";
    DiagnosticCategory[DiagnosticCategory["Message"] = 2] = "Message";
})(exports.DiagnosticCategory || (exports.DiagnosticCategory = {}));
var DiagnosticCategory = exports.DiagnosticCategory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb21waWxlci50cyJdLCJuYW1lcyI6WyJPdXRwdXQiLCJPdXRwdXQuY29uc3RydWN0b3IiLCJPdXRwdXQucmVwb3J0RGlhZ25vc3RpY3MiLCJPdXRwdXQucmVwb3J0RGlhZ25vc3RpY3MuZm9ybWF0IiwiT3V0cHV0LndyaXRlIiwiT3V0cHV0LndyaXRlLmZpbmRFeHQiLCJPdXRwdXQuZW1pdCIsIk91dHB1dC5lbWl0U2NyaXB0cyIsIk91dHB1dC5lbWl0U291cmNlTWFwcyIsIk91dHB1dC5lbWl0RGVjbGFyYXRpb25zIiwiT3V0cHV0LndyaXRlRmlsZXMiLCJPdXRwdXQud3JpdGVGaWxlcy5ta2RpcnBTeW5jIiwiRGlhZ25vc3RpY0NhdGVnb3J5Il0sIm1hcHBpbmdzIjoiQUFBQSxJQUFPLEdBQUcsV0FBVyxJQUFJLENBQUMsQ0FBQztBQUMzQixJQUFPLEtBQUssV0FBVyxNQUFNLENBQUMsQ0FBQztBQUMvQixJQUFPLEdBQUcsV0FBVyxXQUFXLENBQUMsQ0FBQztBQUNsQyxJQUFPLEtBQUssV0FBVyxRQUFRLENBQUMsQ0FBQztBQWVqQztJQUFBQTtRQUNJQyxnQkFBV0EsR0FBaUJBLEVBQUVBLENBQUNBO1FBQy9CQSxZQUFPQSxHQUFlQSxFQUFFQSxDQUFDQTtRQUN6QkEsZUFBVUEsR0FBZUEsRUFBRUEsQ0FBQ0E7UUFDNUJBLGlCQUFZQSxHQUFlQSxFQUFFQSxDQUFDQTtJQWlIbENBLENBQUNBO0lBL0dHRCxrQ0FBaUJBLEdBQWpCQTtRQUNJRSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMxQkEsSUFBSUEsUUFBUUEsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0Esa0NBQWtDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM1RUEsR0FBR0EsQ0FB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QUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFFQSxFQUFFQSxRQUFRQSxFQUFFQSxPQUFPQSxFQUFFQSxDQUFDQSxDQUFDQTtTQUN0RUE7UUFFREEsb0JBQW9CQSxJQUFZQTtZQUM1QkMsSUFBSUEsQ0FBQ0E7Z0JBQ0RBLElBQUlBLEtBQUtBLEdBQUdBLEdBQUdBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ3BDQSxDQUNBQTtZQUFBQSxLQUFLQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFBQSxDQUFDQTtZQUNiQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDakNBLFVBQVVBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO2dCQUNoQ0EsR0FBR0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDeEJBLENBQUNBO1FBQ0xBLENBQUNBO0lBQ0xELENBQUNBO0lBQ0xWLGFBQUNBO0FBQURBLENBQUNBLEFBckhELElBcUhDO0FBckhZLGNBQU0sU0FxSGxCLENBQUE7QUFFRCxXQUFZLGtCQUFrQjtJQUMxQlksaUVBQVdBLENBQUFBO0lBQ1hBLDZEQUFTQSxDQUFBQTtJQUNUQSxpRUFBV0EsQ0FBQUE7QUFDZkEsQ0FBQ0EsRUFKVywwQkFBa0IsS0FBbEIsMEJBQWtCLFFBSTdCO0FBSkQsSUFBWSxrQkFBa0IsR0FBbEIsMEJBSVgsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IF9wYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IF9ndSA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpO1xuaW1wb3J0IF91dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7XG5pbXBvcnQgX2xhbmcgPSByZXF1aXJlKCcuL2xhbmcnKTtcblxuZXhwb3J0IGludGVyZmFjZSBPcHRpb24ge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0eXBlOiBzdHJpbmcgfCBfbGFuZy5NYXA8bnVtYmVyPjtcbiAgICBpc0ZpbGVQYXRoPzogYm9vbGVhbjtcbiAgICBleHBlcmltZW50YWw/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbXBpbGVyIHtcbiAgICBvcHRpb25zKCk6IE9wdGlvbltdO1xuICAgIGNvbXBpbGUob3B0aW9uczogYW55LCBmaWxlTmFtZXM6IHN0cmluZ1tdLCBvdXRwdXQ6IE91dHB1dCk7XG59XG5cbmV4cG9ydCBjbGFzcyBPdXRwdXQge1xuICAgIGRpYWdub3N0aWNzOiBEaWFnbm9zdGljW10gPSBbXTtcbiAgICBzY3JpcHRzOiBfZ3UuRmlsZVtdID0gW107XG4gICAgc291cmNlTWFwczogX2d1LkZpbGVbXSA9IFtdO1xuICAgIGRlY2xhcmF0aW9uczogX2d1LkZpbGVbXSA9IFtdO1xuXG4gICAgcmVwb3J0RGlhZ25vc3RpY3MoKSB7XG4gICAgICAgIGlmICh0aGlzLmRpYWdub3N0aWNzLmxlbmd0aCkge1xuICAgICAgICAgICAgbGV0IG1lc3NhZ2VzID0gW1N0cmluZyhfZ3UuY29sb3JzLnJlZCgnVHlwZVNjcmlwdCBjb21waWxlciBkaWFnbm9zdGljczonKSldO1xuICAgICAgICAgICAgZm9yIChsZXQgZCBvZiB0aGlzLmRpYWdub3N0aWNzKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaChmb3JtYXQoZCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgX2d1LmxvZyhtZXNzYWdlcy5qb2luKCdcXG4nKSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBmb3JtYXQoZDogRGlhZ25vc3RpYyk6IHN0cmluZyB7XG4gICAgICAgICAgICBsZXQgY2F0ZWdvcnkgPSB7XG4gICAgICAgICAgICAgICAgW0RpYWdub3N0aWNDYXRlZ29yeS5XYXJuaW5nXTogJ3dhcm5pbmcnLFxuICAgICAgICAgICAgICAgIFtEaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3JdOiAnZXJyb3InLFxuICAgICAgICAgICAgICAgIFtEaWFnbm9zdGljQ2F0ZWdvcnkuTWVzc2FnZV06ICdtZXNzYWdlJyxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBsZXQgb3V0cHV0ID0gJyc7XG4gICAgICAgICAgICBpZiAoZC5maWxlTmFtZSkge1xuICAgICAgICAgICAgICAgIG91dHB1dCArPSBgJHtfcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBkLmZpbGVOYW1lKX0oJHtkLmxpbmUgKyAxfSwke2QuY2hhcmFjdGVyICsgMX0pOiBgO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb3V0cHV0ICs9IGAke2NhdGVnb3J5W2QuY2F0ZWdvcnldfSBUUyR7ZC5jb2RlfTogJHtkLm1lc3NhZ2V9YDtcbiAgICAgICAgICAgIGxldCBsZXZlbCA9IDE7XG4gICAgICAgICAgICBsZXQgbmV4dCA9IGQubmV4dDtcbiAgICAgICAgICAgIHdoaWxlIChuZXh0KSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0ICs9ICdcXG4nO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGV2ZWw7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBvdXRwdXQgKz0gJyAgJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb3V0cHV0ICs9IG5leHQubWVzc2FnZTtcbiAgICAgICAgICAgICAgICBsZXZlbCsrO1xuICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0Lm5leHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb3V0cHV0O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgd3JpdGUoYmFzZTogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIGRhdGE6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBsZXQgZmlsZSA9IG5ldyBfZ3UuRmlsZSh7XG4gICAgICAgICAgICBiYXNlOiBiYXNlLFxuICAgICAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgICAgIGNvbnRlbnRzOiBuZXcgQnVmZmVyKGRhdGEpXG4gICAgICAgIH0pO1xuICAgICAgICBsZXQgeyBiYXNlbmFtZSwgZXh0IH0gPSBmaW5kRXh0KHBhdGgpO1xuICAgICAgICBzd2l0Y2ggKGV4dCkge1xuICAgICAgICAgICAgY2FzZSAnLmpzJzpcbiAgICAgICAgICAgIGNhc2UgJy5qc3gnOlxuICAgICAgICAgICAgICAgIHRoaXMuc2NyaXB0cy5wdXNoKGZpbGUpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnLmpzLm1hcCc6XG4gICAgICAgICAgICBjYXNlICcuanN4Lm1hcCc6XG4gICAgICAgICAgICAgICAgdGhpcy5zb3VyY2VNYXBzLnB1c2goZmlsZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICcuZC50cyc6XG4gICAgICAgICAgICAgICAgdGhpcy5kZWNsYXJhdGlvbnMucHVzaChmaWxlKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGV4dGVuc2lvbiBvZiBmaWxlICcke3BhdGh9J2ApO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZmluZEV4dChwYXRoOiBzdHJpbmcpOiB7IGJhc2VuYW1lOiBzdHJpbmc7IGV4dDogc3RyaW5nOyB9IHtcbiAgICAgICAgICAgIGxldCBzdWZmaXhlcyA9IFsnLmpzJywgJy5qc3gnLCAnLmpzLm1hcCcsICcuanN4Lm1hcCcsICcuZC50cyddO1xuICAgICAgICAgICAgZm9yIChsZXQgc3VmZml4IG9mIHN1ZmZpeGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhdGguZW5kc1dpdGgoc3VmZml4KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYmFzZW5hbWU6IHBhdGguc3Vic3RyaW5nKDAsIHBhdGgubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCksXG4gICAgICAgICAgICAgICAgICAgICAgICBleHQ6IHN1ZmZpeFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBiYXNlbmFtZTogcGF0aCxcbiAgICAgICAgICAgICAgICBleHQ6IG51bGxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVtaXQoKSB7XG4gICAgICAgIHJldHVybiBuZXcgX3V0aWwuUGFzc1Rocm91Z2hTdHJlYW0oXG4gICAgICAgICAgICBbXS5jb25jYXQodGhpcy5zY3JpcHRzLCB0aGlzLnNvdXJjZU1hcHMsIHRoaXMuZGVjbGFyYXRpb25zKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGVtaXRTY3JpcHRzKCkge1xuICAgICAgICByZXR1cm4gbmV3IF91dGlsLlBhc3NUaHJvdWdoU3RyZWFtKHRoaXMuc2NyaXB0cyk7XG4gICAgfVxuXG4gICAgZW1pdFNvdXJjZU1hcHMoKSB7XG4gICAgICAgIHJldHVybiBuZXcgX3V0aWwuUGFzc1Rocm91Z2hTdHJlYW0odGhpcy5zb3VyY2VNYXBzKTtcbiAgICB9XG5cbiAgICBlbWl0RGVjbGFyYXRpb25zKCkge1xuICAgICAgICByZXR1cm4gbmV3IF91dGlsLlBhc3NUaHJvdWdoU3RyZWFtKHRoaXMuZGVjbGFyYXRpb25zKTtcbiAgICB9XG5cbiAgICB3cml0ZUZpbGVzKCkge1xuICAgICAgICBsZXQgZmlsZXMgPSBbXS5jb25jYXQodGhpcy5zY3JpcHRzLCB0aGlzLnNvdXJjZU1hcHMsIHRoaXMuZGVjbGFyYXRpb25zKTtcbiAgICAgICAgZm9yIChsZXQgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgbWtkaXJwU3luYyhfcGF0aC5kaXJuYW1lKGZpbGUucGF0aCkpO1xuICAgICAgICAgICAgX2ZzLndyaXRlRmlsZVN5bmMoZmlsZS5wYXRoLCBmaWxlLmNvbnRlbnRzLCB7IGVuY29kaW5nOiAnVVRGLTgnIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gbWtkaXJwU3luYyhwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdmFyIHN0YXRzID0gX2ZzLmxzdGF0U3luYyhwYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChleCkge31cbiAgICAgICAgICAgIGlmICghc3RhdHMgfHwgIXN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgICAgICBta2RpcnBTeW5jKF9wYXRoLmRpcm5hbWUocGF0aCkpO1xuICAgICAgICAgICAgICAgIF9mcy5ta2RpclN5bmMocGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBlbnVtIERpYWdub3N0aWNDYXRlZ29yeSB7XG4gICAgV2FybmluZyA9IDAsXG4gICAgRXJyb3IgPSAxLFxuICAgIE1lc3NhZ2UgPSAyLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIERpYWdub3N0aWMgZXh0ZW5kcyBEaWFnbm9zdGljQ2hhaW4ge1xuICAgIGZpbGVOYW1lOiBzdHJpbmc7XG4gICAgc3RhcnQ6IG51bWJlcjtcbiAgICBsZW5ndGg6IG51bWJlcjtcbiAgICBsaW5lOiBudW1iZXI7XG4gICAgY2hhcmFjdGVyOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGlhZ25vc3RpY0NoYWluIHtcbiAgICBjYXRlZ29yeTogRGlhZ25vc3RpY0NhdGVnb3J5O1xuICAgIGNvZGU6IG51bWJlcjtcbiAgICBtZXNzYWdlOiBzdHJpbmc7XG4gICAgbmV4dD86IERpYWdub3N0aWNDaGFpbjtcbn1cbiJdfQ==