/// <reference path="../d/typescript-1.6.d.ts" />
var _compiler = require('../compiler');
var _lang = require('../lang');
var TS_1_6_Adapter = (function () {
    function TS_1_6_Adapter(_ts) {
        this._ts = _ts;
    }
    TS_1_6_Adapter.prototype.compile = function (options, fileNames, result) {
        var parseConfigResult = this._ts.parseConfigFile({
            'compilerOptions': options,
            'files': fileNames
        }, null, process.cwd());
        if (parseConfigResult.errors.length > 0) {
            this._reportDiagnostics(parseConfigResult.errors, result);
        }
        else {
            this._compileImpl(parseConfigResult.options, parseConfigResult.fileNames, result);
        }
    };
    TS_1_6_Adapter.prototype._compileImpl = function (options, fileNames, result) {
        var host = this._ts.createCompilerHost(options);
        var program = this._ts.createProgram(fileNames, options, new CompilerHost(host));
        this._reportDiagnostics(program.getOptionsDiagnostics(), result);
        this._reportDiagnostics(program.getGlobalDiagnostics(), result);
        this._reportDiagnostics(program.getSyntacticDiagnostics(), result);
        this._reportDiagnostics(program.getSemanticDiagnostics(), result);
        this._reportDiagnostics(program.getDeclarationDiagnostics(), result);
        var emitResult = program.emit(undefined, write, undefined);
        result.emitSkipped = emitResult.emitSkipped;
        this._reportDiagnostics(emitResult.diagnostics, result);
        function write(fileName, data) {
            result._create(options.rootDir, fileName, data);
        }
    };
    TS_1_6_Adapter.prototype._reportDiagnostics = function (diagnostics, result) {
        for (var _i = 0; _i < diagnostics.length; _i++) {
            var tsd = diagnostics[_i];
            result.diagnostics.push(this._mapDiagnostic(tsd));
        }
    };
    TS_1_6_Adapter.prototype._mapDiagnostic = function (tsd) {
        var cm = (_a = {},
            _a[this._ts.DiagnosticCategory.Warning] = _compiler.DiagnosticCategory.Warning,
            _a[this._ts.DiagnosticCategory.Error] = _compiler.DiagnosticCategory.Error,
            _a[this._ts.DiagnosticCategory.Message] = _compiler.DiagnosticCategory.Message,
            _a
        );
        var cd = diagnostic(tsd);
        if (tsd.file) {
            var p = this._ts.getLineAndCharacterOfPosition(tsd.file, tsd.start);
            cd.fileName = tsd.file.fileName;
            cd.start = tsd.start;
            cd.length = tsd.length;
            cd.line = p.line;
            cd.character = p.character;
        }
        return cd;
        function diagnostic(tsd) {
            if (_lang.isString(tsd.messageText)) {
                return new _compiler.Diagnostic(cm[tsd.category], tsd.code, tsd.messageText);
            }
            else {
                var tsc = tsd.messageText;
                return new _compiler.Diagnostic(cm[tsd.category], tsd.code, tsc.messageText, chain(tsc.next));
            }
        }
        function chain(tsc) {
            if (tsc) {
                return new _compiler.DiagnosticChain(cm[tsc.category], tsc.code, tsc.messageText, chain(tsc.next));
            }
            else {
                return null;
            }
        }
        var _a;
    };
    TS_1_6_Adapter.VERSION = '~1.6.2';
    return TS_1_6_Adapter;
})();
var CompilerHost = (function () {
    function CompilerHost(target) {
        this._target = target;
    }
    CompilerHost.prototype.writeFile = function (fileName, data, writeByteOrderMark, onError) {
        this._target.writeFile(fileName, data, writeByteOrderMark, onError);
    };
    CompilerHost.prototype.getSourceFile = function (fileName, languageVersion, onError) {
        return this._target.getSourceFile(fileName, languageVersion, onError);
    };
    CompilerHost.prototype.getDefaultLibFileName = function (options) {
        return this._target.getDefaultLibFileName(options);
    };
    CompilerHost.prototype.getCurrentDirectory = function () {
        return this._target.getCurrentDirectory();
    };
    CompilerHost.prototype.getCanonicalFileName = function (fileName) {
        return this._target.getCanonicalFileName(fileName);
    };
    CompilerHost.prototype.useCaseSensitiveFileNames = function () {
        return this._target.useCaseSensitiveFileNames();
    };
    CompilerHost.prototype.getNewLine = function () {
        return this._target.getNewLine();
    };
    CompilerHost.prototype.fileExists = function (fileName) {
        return this._target.fileExists(fileName);
    };
    CompilerHost.prototype.readFile = function (fileName) {
        return this._target.readFile(fileName);
    };
    return CompilerHost;
})();
module.exports = TS_1_6_Adapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVFNfMV82LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVFNfMV82LnRzIl0sIm5hbWVzIjpbIlRTXzFfNl9BZGFwdGVyIiwiVFNfMV82X0FkYXB0ZXIuY29uc3RydWN0b3IiLCJUU18xXzZfQWRhcHRlci5jb21waWxlIiwiVFNfMV82X0FkYXB0ZXIuX2NvbXBpbGVJbXBsIiwiVFNfMV82X0FkYXB0ZXIuX2NvbXBpbGVJbXBsLndyaXRlIiwiVFNfMV82X0FkYXB0ZXIuX3JlcG9ydERpYWdub3N0aWNzIiwiVFNfMV82X0FkYXB0ZXIuX21hcERpYWdub3N0aWMiLCJUU18xXzZfQWRhcHRlci5fbWFwRGlhZ25vc3RpYy5kaWFnbm9zdGljIiwiVFNfMV82X0FkYXB0ZXIuX21hcERpYWdub3N0aWMuY2hhaW4iLCJDb21waWxlckhvc3QiLCJDb21waWxlckhvc3QuY29uc3RydWN0b3IiLCJDb21waWxlckhvc3Qud3JpdGVGaWxlIiwiQ29tcGlsZXJIb3N0LmdldFNvdXJjZUZpbGUiLCJDb21waWxlckhvc3QuZ2V0RGVmYXVsdExpYkZpbGVOYW1lIiwiQ29tcGlsZXJIb3N0LmdldEN1cnJlbnREaXJlY3RvcnkiLCJDb21waWxlckhvc3QuZ2V0Q2Fub25pY2FsRmlsZU5hbWUiLCJDb21waWxlckhvc3QudXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lcyIsIkNvbXBpbGVySG9zdC5nZXROZXdMaW5lIiwiQ29tcGlsZXJIb3N0LmZpbGVFeGlzdHMiLCJDb21waWxlckhvc3QucmVhZEZpbGUiXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQUdqRCxJQUFPLFNBQVMsV0FBVyxhQUFhLENBQUMsQ0FBQztBQUUxQyxJQUFPLEtBQUssV0FBVyxTQUFTLENBQUMsQ0FBQztBQUVsQztJQUdJQSx3QkFBb0JBLEdBQWNBO1FBQWRDLFFBQUdBLEdBQUhBLEdBQUdBLENBQVdBO0lBQUdBLENBQUNBO0lBRXRDRCxnQ0FBT0EsR0FBUEEsVUFBUUEsT0FBWUEsRUFBRUEsU0FBbUJBLEVB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QUNBO0lBQ3ZEQSxDQUFDQTtJQUVETixnREFBeUJBLEdBQXpCQTtRQUNJTyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSx5QkFBeUJBLEVBQUVBLENBQUNBO0lBQ3BEQSxDQUFDQTtJQUVEUCxpQ0FBVUEsR0FBVkE7UUFDSVEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0E7SUFDckNBLENBQUNBO0lBRURSLGlDQUFVQSxHQUFWQSxVQUFXQSxRQUFnQkE7UUFDdkJTLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFVBQVVBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO0lBQzdDQSxDQUFDQTtJQUVEVCwrQkFBUUEsR0FBUkEsVUFBU0EsUUFBZ0JBO1FBQ3JCVSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUMzQ0EsQ0FBQ0E7SUFDTFYsbUJBQUNBO0FBQURBLENBQUNBLEFBMUNELElBMENDO0FBRUQsaUJBQVMsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL2QvdHlwZXNjcmlwdC0xLjYuZC50c1wiIC8+XG5cbmltcG9ydCB0cyA9IFRTXzFfNjtcbmltcG9ydCBfY29tcGlsZXIgPSByZXF1aXJlKCcuLi9jb21waWxlcicpO1xuaW1wb3J0IF91dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpO1xuaW1wb3J0IF9sYW5nID0gcmVxdWlyZSgnLi4vbGFuZycpO1xuXG5jbGFzcyBUU18xXzZfQWRhcHRlciBpbXBsZW1lbnRzIF9jb21waWxlci5Db21waWxlciB7XG4gICAgc3RhdGljIFZFUlNJT04gPSAnfjEuNi4yJztcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX3RzOiB0eXBlb2YgdHMpIHt9XG5cbiAgICBjb21waWxlKG9wdGlvbnM6IGFueSwgZmlsZU5hbWVzOiBzdHJpbmdbXSwgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KSB7XG4gICAgICAgIGxldCBwYXJzZUNvbmZpZ1Jlc3VsdCA9IHRoaXMuX3RzLnBhcnNlQ29uZmlnRmlsZSh7XG4gICAgICAgICAgICAnY29tcGlsZXJPcHRpb25zJzogb3B0aW9ucyxcbiAgICAgICAgICAgICdmaWxlcyc6IGZpbGVOYW1lc1xuICAgICAgICB9LCBudWxsLCBwcm9jZXNzLmN3ZCgpKTtcblxuICAgICAgICBpZiAocGFyc2VDb25maWdSZXN1bHQuZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHBhcnNlQ29uZmlnUmVzdWx0LmVycm9ycywgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2NvbXBpbGVJbXBsKHBhcnNlQ29uZmlnUmVzdWx0Lm9wdGlvbnMsIHBhcnNlQ29uZmlnUmVzdWx0LmZpbGVOYW1lcywgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2NvbXBpbGVJbXBsKG9wdGlvbnM6IHRzLkNvbXBpbGVyT3B0aW9ucywgZmlsZU5hbWVzOiBzdHJpbmdbXSwgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KSB7XG4gICAgICAgIGxldCBob3N0ID0gdGhpcy5fdHMuY3JlYXRlQ29tcGlsZXJIb3N0KG9wdGlvbnMpO1xuICAgICAgICBsZXQgcHJvZ3JhbSA9IHRoaXMuX3RzLmNyZWF0ZVByb2dyYW0oZmlsZU5hbWVzLCBvcHRpb25zLCBuZXcgQ29tcGlsZXJIb3N0KGhvc3QpKTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXRPcHRpb25zRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXRHbG9iYWxEaWFnbm9zdGljcygpLCByZXN1bHQpO1xuICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwcm9ncmFtLmdldFN5bnRhY3RpY0RpYWdub3N0aWNzKCksIHJlc3VsdCk7XG4gICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHByb2dyYW0uZ2V0U2VtYW50aWNEaWFnbm9zdGljcygpLCByZXN1bHQpO1xuICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwcm9ncmFtLmdldERlY2xhcmF0aW9uRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgbGV0IGVtaXRSZXN1bHQgPSBwcm9ncmFtLmVtaXQodW5kZWZpbmVkLCB3cml0ZSwgdW5kZWZpbmVkKTtcbiAgICAgICAgcmVzdWx0LmVtaXRTa2lwcGVkID0gZW1pdFJlc3VsdC5lbWl0U2tpcHBlZDtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MoZW1pdFJlc3VsdC5kaWFnbm9zdGljcywgcmVzdWx0KTtcblxuICAgICAgICBmdW5jdGlvbiB3cml0ZShmaWxlTmFtZTogc3RyaW5nLCBkYXRhOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIHJlc3VsdC5fY3JlYXRlKG9wdGlvbnMucm9vdERpciwgZmlsZU5hbWUsIGRhdGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVwb3J0RGlhZ25vc3RpY3MoZGlhZ25vc3RpY3M6IHRzLkRpYWdub3N0aWNbXSwgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KSB7XG4gICAgICAgIGZvciAobGV0IHRzZCBvZiBkaWFnbm9zdGljcykge1xuICAgICAgICAgICAgcmVzdWx0LmRpYWdub3N0aWNzLnB1c2godGhpcy5fbWFwRGlhZ25vc3RpYyh0c2QpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX21hcERpYWdub3N0aWModHNkOiB0cy5EaWFnbm9zdGljKTogX2NvbXBpbGVyLkRpYWdub3N0aWMge1xuICAgICAgICBsZXQgY20gPSB7XG4gICAgICAgICAgICBbdGhpcy5fdHMuRGlhZ25vc3RpY0NhdGVnb3J5Lldhcm5pbmddOiBfY29tcGlsZXIuRGlhZ25vc3RpY0NhdGVnb3J5Lldhcm5pbmcsXG4gICAgICAgICAgICBbdGhpcy5fdHMuRGlhZ25vc3RpY0NhdGVnb3J5LkVycm9yXTogX2NvbXBpbGVyLkRpYWdub3N0aWNDYXRlZ29yeS5FcnJvcixcbiAgICAgICAgICAgIFt0aGlzLl90cy5EaWFnbm9zdGljQ2F0ZWdvcnkuTWVzc2FnZV06IF9jb21waWxlci5EaWFnbm9zdGljQ2F0ZWdvcnkuTWVzc2FnZSxcbiAgICAgICAgfTtcbiAgICAgICAgbGV0IGNkID0gZGlhZ25vc3RpYyh0c2QpO1xuICAgICAgICBpZiAodHNkLmZpbGUpIHtcbiAgICAgICAgICAgIGxldCBwID0gdGhpcy5fdHMuZ2V0TGluZUFuZENoYXJhY3Rlck9mUG9zaXRpb24odHNkLmZpbGUsIHRzZC5zdGFydCk7XG4gICAgICAgICAgICBjZC5maWxlTmFtZSA9IHRzZC5maWxlLmZpbGVOYW1lO1xuICAgICAgICAgICAgY2Quc3RhcnQgPSB0c2Quc3RhcnQ7XG4gICAgICAgICAgICBjZC5sZW5ndGggPSB0c2QubGVuZ3RoO1xuICAgICAgICAgICAgY2QubGluZSA9IHAubGluZTtcbiAgICAgICAgICAgIGNkLmNoYXJhY3RlciA9IHAuY2hhcmFjdGVyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjZDtcblxuICAgICAgICBmdW5jdGlvbiBkaWFnbm9zdGljKHRzZDogdHMuRGlhZ25vc3RpYyk6IF9jb21waWxlci5EaWFnbm9zdGljIHtcbiAgICAgICAgICAgIGlmIChfbGFuZy5pc1N0cmluZyh0c2QubWVzc2FnZVRleHQpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBfY29tcGlsZXIuRGlhZ25vc3RpYyhjbVt0c2QuY2F0ZWdvcnldLCB0c2QuY29kZSwgPHN0cmluZz50c2QubWVzc2FnZVRleHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbGV0IHRzYyA9IDx0cy5EaWFnbm9zdGljTWVzc2FnZUNoYWluPnRzZC5tZXNzYWdlVGV4dDtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IF9jb21waWxlci5EaWFnbm9zdGljKGNtW3RzZC5jYXRlZ29yeV0sIHRzZC5jb2RlLCB0c2MubWVzc2FnZVRleHQsIGNoYWluKHRzYy5uZXh0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBjaGFpbih0c2M6IHRzLkRpYWdub3N0aWNNZXNzYWdlQ2hhaW4pOiBfY29tcGlsZXIuRGlhZ25vc3RpY0NoYWluIHtcbiAgICAgICAgICAgIGlmICh0c2MpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IF9jb21waWxlci5EaWFnbm9zdGljQ2hhaW4oY21bdHNjLmNhdGVnb3J5XSwgdHNjLmNvZGUsIHRzYy5tZXNzYWdlVGV4dCwgY2hhaW4odHNjLm5leHQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5jbGFzcyBDb21waWxlckhvc3QgaW1wbGVtZW50cyB0cy5Db21waWxlckhvc3Qge1xuICAgIHByaXZhdGUgX3RhcmdldDogdHMuQ29tcGlsZXJIb3N0O1xuXG4gICAgY29uc3RydWN0b3IodGFyZ2V0OiB0cy5Db21waWxlckhvc3QpIHtcbiAgICAgICAgdGhpcy5fdGFyZ2V0ID0gdGFyZ2V0O1xuICAgIH1cblxuICAgIHdyaXRlRmlsZShmaWxlTmFtZTogc3RyaW5nLCBkYXRhOiBzdHJpbmcsIHdyaXRlQnl0ZU9yZGVyTWFyazogYm9vbGVhbiwgb25FcnJvcj86IChtZXNzYWdlOiBzdHJpbmcpID0+IHZvaWQpIHtcbiAgICAgICAgdGhpcy5fdGFyZ2V0LndyaXRlRmlsZShmaWxlTmFtZSwgZGF0YSwgd3JpdGVCeXRlT3JkZXJNYXJrLCBvbkVycm9yKTtcbiAgICB9XG5cbiAgICBnZXRTb3VyY2VGaWxlKGZpbGVOYW1lOiBzdHJpbmcsIGxhbmd1YWdlVmVyc2lvbjogdHMuU2NyaXB0VGFyZ2V0LCBvbkVycm9yOiAobWVzc2FnZTogc3RyaW5nKSA9PiB2b2lkKTogdHMuU291cmNlRmlsZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZ2V0U291cmNlRmlsZShmaWxlTmFtZSwgbGFuZ3VhZ2VWZXJzaW9uLCBvbkVycm9yKTtcbiAgICB9XG5cbiAgICBnZXREZWZhdWx0TGliRmlsZU5hbWUob3B0aW9uczogdHMuQ29tcGlsZXJPcHRpb25zKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5nZXREZWZhdWx0TGliRmlsZU5hbWUob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgZ2V0Q3VycmVudERpcmVjdG9yeSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LmdldEN1cnJlbnREaXJlY3RvcnkoKTtcbiAgICB9XG5cbiAgICBnZXRDYW5vbmljYWxGaWxlTmFtZShmaWxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5nZXRDYW5vbmljYWxGaWxlTmFtZShmaWxlTmFtZSk7XG4gICAgfVxuXG4gICAgdXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lcygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC51c2VDYXNlU2Vuc2l0aXZlRmlsZU5hbWVzKCk7XG4gICAgfVxuXG4gICAgZ2V0TmV3TGluZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LmdldE5ld0xpbmUoKTtcbiAgICB9XG5cbiAgICBmaWxlRXhpc3RzKGZpbGVOYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5maWxlRXhpc3RzKGZpbGVOYW1lKTtcbiAgICB9XG5cbiAgICByZWFkRmlsZShmaWxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5yZWFkRmlsZShmaWxlTmFtZSk7XG4gICAgfVxufVxuXG5leHBvcnQgPSBUU18xXzZfQWRhcHRlcjtcbiJdfQ==