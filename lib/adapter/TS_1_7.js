/// <reference path="../d/typescript-1.7.d.ts" />
var _compiler = require('../compiler');
var _lang = require('../lang');
var TS_1_7_Adapter = (function () {
    function TS_1_7_Adapter(_ts) {
        this._ts = _ts;
    }
    TS_1_7_Adapter.prototype.compile = function (options, fileNames, result) {
        var parseConfigResult = this._ts.parseJsonConfigFileContent({
            'compilerOptions': options,
            'files': fileNames
        }, null, process.cwd());
        if (parseConfigResult.errors.length > 0) {
            this._reportDiagnostics(parseConfigResult.errors, result);
        }
        else {
            this._compileImpl(parseConfigResult.options, parseConfigResult.fileNames, result);
        }
    };
    TS_1_7_Adapter.prototype._compileImpl = function (options, fileNames, result) {
        var host = this._ts.createCompilerHost(options);
        var program = this._ts.createProgram(fileNames, options, new CompilerHost(host));
        this._reportDiagnostics(program.getOptionsDiagnostics(), result);
        this._reportDiagnostics(program.getGlobalDiagnostics(), result);
        this._reportDiagnostics(program.getSyntacticDiagnostics(), result);
        this._reportDiagnostics(program.getSemanticDiagnostics(), result);
        this._reportDiagnostics(program.getDeclarationDiagnostics(), result);
        var emitResult = program.emit(undefined, write, undefined);
        result.emitSkipped = emitResult.emitSkipped;
        this._reportDiagnostics(emitResult.diagnostics, result);
        function write(fileName, data) {
            result._create(options.rootDir, fileName, data);
        }
    };
    TS_1_7_Adapter.prototype._reportDiagnostics = function (diagnostics, result) {
        for (var _i = 0; _i < diagnostics.length; _i++) {
            var diagnostic = diagnostics[_i];
            this._reportDiagnostic(diagnostic, result);
        }
    };
    TS_1_7_Adapter.prototype._reportDiagnostic = function (diagnostic, result) {
        var category = (_a = {},
            _a[this._ts.DiagnosticCategory.Warning] = _compiler.DiagnosticCategory.Warning,
            _a[this._ts.DiagnosticCategory.Error] = _compiler.DiagnosticCategory.Error,
            _a[this._ts.DiagnosticCategory.Message] = _compiler.DiagnosticCategory.Message,
            _a
        );
        var d = empty();
        if (diagnostic.file) {
            var p = this._ts.getLineAndCharacterOfPosition(diagnostic.file, diagnostic.start);
            d.fileName = diagnostic.file.fileName;
            d.start = diagnostic.start;
            d.length = diagnostic.length;
            d.line = p.line;
            d.character = p.character;
        }
        d.category = category[diagnostic.category];
        d.code = diagnostic.code;
        if (_lang.isString(diagnostic.messageText)) {
            d.message = diagnostic.messageText;
        }
        else {
            message(d, diagnostic.messageText);
        }
        result.diagnostics.push(d);
        function message(d, next) {
            d.message = next.messageText;
            next = next.next;
            while (next) {
                var t = empty();
                t.category = category[next.category];
                t.code = next.code;
                t.message = next.messageText;
                d.next = t;
                d = t;
                next = next.next;
            }
        }
        function empty() {
            return {
                fileName: null,
                start: null,
                length: null,
                line: null,
                character: null,
                category: null,
                code: null,
                message: null,
                next: null
            };
        }
        var _a;
    };
    TS_1_7_Adapter.VERSION = '~1.7.2';
    return TS_1_7_Adapter;
})();
var CompilerHost = (function () {
    function CompilerHost(target) {
        this._target = target;
    }
    CompilerHost.prototype.writeFile = function (fileName, data, writeByteOrderMark, onError) {
        this._target.writeFile(fileName, data, writeByteOrderMark, onError);
    };
    CompilerHost.prototype.getSourceFile = function (fileName, languageVersion, onError) {
        return this._target.getSourceFile(fileName, languageVersion, onError);
    };
    CompilerHost.prototype.getDefaultLibFileName = function (options) {
        return this._target.getDefaultLibFileName(options);
    };
    CompilerHost.prototype.getCurrentDirectory = function () {
        return this._target.getCurrentDirectory();
    };
    CompilerHost.prototype.getCanonicalFileName = function (fileName) {
        return this._target.getCanonicalFileName(fileName);
    };
    CompilerHost.prototype.useCaseSensitiveFileNames = function () {
        return this._target.useCaseSensitiveFileNames();
    };
    CompilerHost.prototype.getNewLine = function () {
        return this._target.getNewLine();
    };
    CompilerHost.prototype.fileExists = function (fileName) {
        return this._target.fileExists(fileName);
    };
    CompilerHost.prototype.readFile = function (fileName) {
        return this._target.readFile(fileName);
    };
    return CompilerHost;
})();
module.exports = TS_1_7_Adapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVFNfMV83LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVFNfMV83LnRzIl0sIm5hbWVzIjpbIlRTXzFfN19BZGFwdGVyIiwiVFNfMV83X0FkYXB0ZXIuY29uc3RydWN0b3IiLCJUU18xXzdfQWRhcHRlci5jb21waWxlIiwiVFNfMV83X0FkYXB0ZXIuX2NvbXBpbGVJbXBsIiwiVFNfMV83X0FkYXB0ZXIuX2NvbXBpbGVJbXBsLndyaXRlIiwiVFNfMV83X0FkYXB0ZXIuX3JlcG9ydERpYWdub3N0aWNzIiwiVFNfMV83X0FkYXB0ZXIuX3JlcG9ydERpYWdub3N0aWMiLCJUU18xXzdfQWRhcHRlci5fcmVwb3J0RGlhZ25vc3RpYy5tZXNzYWdlIiwiVFNfMV83X0FkYXB0ZXIuX3JlcG9ydERpYWdub3N0aWMuZW1wdHkiLCJDb21waWxlckhvc3QiLCJDb21waWxlckhvc3QuY29uc3RydWN0b3IiLCJDb21waWxlckhvc3Qud3JpdGVGaWxlIiwiQ29tcGlsZXJIb3N0LmdldFNvdXJjZUZpbGUiLCJDb21waWxlckhvc3QuZ2V0RGVmYXVsdExpYkZpbGVOYW1lIiwiQ29tcGlsZXJIb3N0LmdldEN1cnJlbnREaXJlY3RvcnkiLCJDb21waWxlckhvc3QuZ2V0Q2Fub25pY2FsRmlsZU5hbWUiLCJDb21waWxlckhvc3QudXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lcyIsIkNvbXBpbGVySG9zdC5nZXROZXdMaW5lIiwiQ29tcGlsZXJIb3N0LmZpbGVFeGlzdHMiLCJDb21waWxlckhvc3QucmVhZEZpbGUiXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQUdqRCxJQUFPLFNBQVMsV0FBVyxhQUFhLENBQUMsQ0FBQztBQUUxQyxJQUFPLEtBQUssV0FBVyxTQUFTLENBQUMsQ0FBQztBQUVsQztJQUdJQSx3QkFBb0JBLEdBQWNBO1FBQWRDLFFBQUdBLEdBQUhBLEdBQUdBLENBQVdBO0lBQUdBLENBQUNBO0lBRXRDRCxnQ0FBT0EsR0FBUEEsVUFBUUEsT0FBWUEsRUFBRUEsU0FB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c0JBLE9BQTJCQTtRQUM3Q0ksTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EscUJBQXFCQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtJQUN2REEsQ0FBQ0E7SUFFREosMENBQW1CQSxHQUFuQkE7UUFDSUssTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsbUJBQW1CQSxFQUFFQSxDQUFDQTtJQUM5Q0EsQ0FBQ0E7SUFFREwsMkNBQW9CQSxHQUFwQkEsVUFBcUJBLFFBQWdCQTtRQUNqQ00sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUN2REEsQ0FBQ0E7SUFFRE4sZ0RBQXlCQSxHQUF6QkE7UUFDSU8sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EseUJBQXlCQSxFQUFFQSxDQUFDQTtJQUNwREEsQ0FBQ0E7SUFFRFAsaUNBQVVBLEdBQVZBO1FBQ0lRLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO0lBQ3JDQSxDQUFDQTtJQUVEUixpQ0FBVUEsR0FBVkEsVUFBV0EsUUFBZ0JBO1FBQ3ZCUyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUM3Q0EsQ0FBQ0E7SUFFRFQsK0JBQVFBLEdBQVJBLFVBQVNBLFFBQWdCQTtRQUNyQlUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDM0NBLENBQUNBO0lBQ0xWLG1CQUFDQTtBQUFEQSxDQUFDQSxBQTFDRCxJQTBDQztBQUVELGlCQUFTLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9kL3R5cGVzY3JpcHQtMS43LmQudHNcIiAvPlxuXG5pbXBvcnQgdHMgPSBUU18xXzc7XG5pbXBvcnQgX2NvbXBpbGVyID0gcmVxdWlyZSgnLi4vY29tcGlsZXInKTtcbmltcG9ydCBfdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTtcbmltcG9ydCBfbGFuZyA9IHJlcXVpcmUoJy4uL2xhbmcnKTtcblxuY2xhc3MgVFNfMV83X0FkYXB0ZXIgaW1wbGVtZW50cyBfY29tcGlsZXIuQ29tcGlsZXIge1xuICAgIHN0YXRpYyBWRVJTSU9OID0gJ34xLjcuMic7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF90czogdHlwZW9mIHRzKSB7fVxuXG4gICAgY29tcGlsZShvcHRpb25zOiBhbnksIGZpbGVOYW1lczogc3RyaW5nW10sIHJlc3VsdDogX2NvbXBpbGVyLlJlc3VsdCkge1xuICAgICAgICBsZXQgcGFyc2VDb25maWdSZXN1bHQgPSB0aGlzLl90cy5wYXJzZUpzb25Db25maWdGaWxlQ29udGVudCh7XG4gICAgICAgICAgICAnY29tcGlsZXJPcHRpb25zJzogb3B0aW9ucyxcbiAgICAgICAgICAgICdmaWxlcyc6IGZpbGVOYW1lc1xuICAgICAgICB9LCBudWxsLCBwcm9jZXNzLmN3ZCgpKTtcblxuICAgICAgICBpZiAocGFyc2VDb25maWdSZXN1bHQuZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHBhcnNlQ29uZmlnUmVzdWx0LmVycm9ycywgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2NvbXBpbGVJbXBsKHBhcnNlQ29uZmlnUmVzdWx0Lm9wdGlvbnMsIHBhcnNlQ29uZmlnUmVzdWx0LmZpbGVOYW1lcywgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2NvbXBpbGVJbXBsKG9wdGlvbnM6IHRzLkNvbXBpbGVyT3B0aW9ucywgZmlsZU5hbWVzOiBzdHJpbmdbXSwgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KSB7XG4gICAgICAgIGxldCBob3N0ID0gdGhpcy5fdHMuY3JlYXRlQ29tcGlsZXJIb3N0KG9wdGlvbnMpO1xuICAgICAgICBsZXQgcHJvZ3JhbSA9IHRoaXMuX3RzLmNyZWF0ZVByb2dyYW0oZmlsZU5hbWVzLCBvcHRpb25zLCBuZXcgQ29tcGlsZXJIb3N0KGhvc3QpKTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXRPcHRpb25zRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXRHbG9iYWxEaWFnbm9zdGljcygpLCByZXN1bHQpO1xuICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwcm9ncmFtLmdldFN5bnRhY3RpY0RpYWdub3N0aWNzKCksIHJlc3VsdCk7XG4gICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHByb2dyYW0uZ2V0U2VtYW50aWNEaWFnbm9zdGljcygpLCByZXN1bHQpO1xuICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwcm9ncmFtLmdldERlY2xhcmF0aW9uRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgbGV0IGVtaXRSZXN1bHQgPSBwcm9ncmFtLmVtaXQodW5kZWZpbmVkLCB3cml0ZSwgdW5kZWZpbmVkKTtcbiAgICAgICAgcmVzdWx0LmVtaXRTa2lwcGVkID0gZW1pdFJlc3VsdC5lbWl0U2tpcHBlZDtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MoZW1pdFJlc3VsdC5kaWFnbm9zdGljcywgcmVzdWx0KTtcblxuICAgICAgICBmdW5jdGlvbiB3cml0ZShmaWxlTmFtZTogc3RyaW5nLCBkYXRhOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIHJlc3VsdC5fY3JlYXRlKG9wdGlvbnMucm9vdERpciwgZmlsZU5hbWUsIGRhdGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfcmVwb3J0RGlhZ25vc3RpY3MoZGlhZ25vc3RpY3M6IHRzLkRpYWdub3N0aWNbXSwgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KSB7XG4gICAgICAgIGZvciAobGV0IGRpYWdub3N0aWMgb2YgZGlhZ25vc3RpY3MpIHtcbiAgICAgICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWMoZGlhZ25vc3RpYywgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3JlcG9ydERpYWdub3N0aWMoZGlhZ25vc3RpYzogdHMuRGlhZ25vc3RpYywgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KSB7XG4gICAgICAgIGxldCBjYXRlZ29yeSA9IHtcbiAgICAgICAgICAgIFt0aGlzLl90cy5EaWFnbm9zdGljQ2F0ZWdvcnkuV2FybmluZ106IF9jb21waWxlci5EaWFnbm9zdGljQ2F0ZWdvcnkuV2FybmluZyxcbiAgICAgICAgICAgIFt0aGlzLl90cy5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3JdOiBfY29tcGlsZXIuRGlhZ25vc3RpY0NhdGVnb3J5LkVycm9yLFxuICAgICAgICAgICAgW3RoaXMuX3RzLkRpYWdub3N0aWNDYXRlZ29yeS5NZXNzYWdlXTogX2NvbXBpbGVyLkRpYWdub3N0aWNDYXRlZ29yeS5NZXNzYWdlLFxuICAgICAgICB9O1xuICAgICAgICBsZXQgZCA9IGVtcHR5KCk7XG4gICAgICAgIGlmIChkaWFnbm9zdGljLmZpbGUpIHtcbiAgICAgICAgICAgIGxldCBwID0gdGhpcy5fdHMuZ2V0TGluZUFuZENoYXJhY3Rlck9mUG9zaXRpb24oZGlhZ25vc3RpYy5maWxlLCBkaWFnbm9zdGljLnN0YXJ0KTtcbiAgICAgICAgICAgIGQuZmlsZU5hbWUgPSBkaWFnbm9zdGljLmZpbGUuZmlsZU5hbWU7XG4gICAgICAgICAgICBkLnN0YXJ0ID0gZGlhZ25vc3RpYy5zdGFydDtcbiAgICAgICAgICAgIGQubGVuZ3RoID0gZGlhZ25vc3RpYy5sZW5ndGg7XG4gICAgICAgICAgICBkLmxpbmUgPSBwLmxpbmU7XG4gICAgICAgICAgICBkLmNoYXJhY3RlciA9IHAuY2hhcmFjdGVyO1xuICAgICAgICB9XG4gICAgICAgIGQuY2F0ZWdvcnkgPSBjYXRlZ29yeVtkaWFnbm9zdGljLmNhdGVnb3J5XTtcbiAgICAgICAgZC5jb2RlID0gZGlhZ25vc3RpYy5jb2RlO1xuICAgICAgICBpZiAoX2xhbmcuaXNTdHJpbmcoZGlhZ25vc3RpYy5tZXNzYWdlVGV4dCkpIHtcbiAgICAgICAgICAgIGQubWVzc2FnZSA9IDxzdHJpbmc+ZGlhZ25vc3RpYy5tZXNzYWdlVGV4dDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG1lc3NhZ2UoZCwgPHRzLkRpYWdub3N0aWNNZXNzYWdlQ2hhaW4+ZGlhZ25vc3RpYy5tZXNzYWdlVGV4dCk7XG5cbiAgICAgICAgfVxuICAgICAgICByZXN1bHQuZGlhZ25vc3RpY3MucHVzaChkKTtcblxuICAgICAgICBmdW5jdGlvbiBtZXNzYWdlKGQ6IF9jb21waWxlci5EaWFnbm9zdGljLCBuZXh0OiB0cy5EaWFnbm9zdGljTWVzc2FnZUNoYWluKSB7XG4gICAgICAgICAgICBkLm1lc3NhZ2UgPSBuZXh0Lm1lc3NhZ2VUZXh0O1xuICAgICAgICAgICAgbmV4dCA9IG5leHQubmV4dDtcbiAgICAgICAgICAgIHdoaWxlIChuZXh0KSB7XG4gICAgICAgICAgICAgICAgbGV0IHQgPSBlbXB0eSgpO1xuICAgICAgICAgICAgICAgIHQuY2F0ZWdvcnkgPSBjYXRlZ29yeVtuZXh0LmNhdGVnb3J5XTtcbiAgICAgICAgICAgICAgICB0LmNvZGUgPSBuZXh0LmNvZGU7XG4gICAgICAgICAgICAgICAgdC5tZXNzYWdlID0gbmV4dC5tZXNzYWdlVGV4dDtcbiAgICAgICAgICAgICAgICBkLm5leHQgPSB0O1xuICAgICAgICAgICAgICAgIGQgPSB0O1xuICAgICAgICAgICAgICAgIG5leHQgPSBuZXh0Lm5leHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBlbXB0eSgpOiBfY29tcGlsZXIuRGlhZ25vc3RpYyB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBudWxsLFxuICAgICAgICAgICAgICAgIHN0YXJ0OiBudWxsLFxuICAgICAgICAgICAgICAgIGxlbmd0aDogbnVsbCxcbiAgICAgICAgICAgICAgICBsaW5lOiBudWxsLFxuICAgICAgICAgICAgICAgIGNoYXJhY3RlcjogbnVsbCxcbiAgICAgICAgICAgICAgICBjYXRlZ29yeTogbnVsbCxcbiAgICAgICAgICAgICAgICBjb2RlOiBudWxsLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG51bGwsXG4gICAgICAgICAgICAgICAgbmV4dDogbnVsbFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgQ29tcGlsZXJIb3N0IGltcGxlbWVudHMgdHMuQ29tcGlsZXJIb3N0IHtcbiAgICBwcml2YXRlIF90YXJnZXQ6IHRzLkNvbXBpbGVySG9zdDtcblxuICAgIGNvbnN0cnVjdG9yKHRhcmdldDogdHMuQ29tcGlsZXJIb3N0KSB7XG4gICAgICAgIHRoaXMuX3RhcmdldCA9IHRhcmdldDtcbiAgICB9XG5cbiAgICB3cml0ZUZpbGUoZmlsZU5hbWU6IHN0cmluZywgZGF0YTogc3RyaW5nLCB3cml0ZUJ5dGVPcmRlck1hcms6IGJvb2xlYW4sIG9uRXJyb3I/OiAobWVzc2FnZTogc3RyaW5nKSA9PiB2b2lkKSB7XG4gICAgICAgIHRoaXMuX3RhcmdldC53cml0ZUZpbGUoZmlsZU5hbWUsIGRhdGEsIHdyaXRlQnl0ZU9yZGVyTWFyaywgb25FcnJvcik7XG4gICAgfVxuXG4gICAgZ2V0U291cmNlRmlsZShmaWxlTmFtZTogc3RyaW5nLCBsYW5ndWFnZVZlcnNpb246IHRzLlNjcmlwdFRhcmdldCwgb25FcnJvcjogKG1lc3NhZ2U6IHN0cmluZykgPT4gdm9pZCk6IHRzLlNvdXJjZUZpbGUge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LmdldFNvdXJjZUZpbGUoZmlsZU5hbWUsIGxhbmd1YWdlVmVyc2lvbiwgb25FcnJvcik7XG4gICAgfVxuXG4gICAgZ2V0RGVmYXVsdExpYkZpbGVOYW1lKG9wdGlvbnM6IHRzLkNvbXBpbGVyT3B0aW9ucyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZ2V0RGVmYXVsdExpYkZpbGVOYW1lKG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGdldEN1cnJlbnREaXJlY3RvcnkoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5nZXRDdXJyZW50RGlyZWN0b3J5KCk7XG4gICAgfVxuXG4gICAgZ2V0Q2Fub25pY2FsRmlsZU5hbWUoZmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZ2V0Q2Fub25pY2FsRmlsZU5hbWUoZmlsZU5hbWUpO1xuICAgIH1cblxuICAgIHVzZUNhc2VTZW5zaXRpdmVGaWxlTmFtZXMoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQudXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lcygpO1xuICAgIH1cblxuICAgIGdldE5ld0xpbmUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5nZXROZXdMaW5lKCk7XG4gICAgfVxuXG4gICAgZmlsZUV4aXN0cyhmaWxlTmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZmlsZUV4aXN0cyhmaWxlTmFtZSk7XG4gICAgfVxuXG4gICAgcmVhZEZpbGUoZmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQucmVhZEZpbGUoZmlsZU5hbWUpO1xuICAgIH1cbn1cblxuZXhwb3J0ID0gVFNfMV83X0FkYXB0ZXI7XG4iXX0=