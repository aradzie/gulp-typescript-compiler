/// <reference path="../d/typescript-1.7.d.ts" />
var _compiler = require('../compiler');
var _lang = require('../lang');
var TS_1_7_Adapter = (function () {
    function TS_1_7_Adapter(_ts) {
        this._ts = _ts;
    }
    TS_1_7_Adapter.prototype.compile = function (options, fileNames, result) {
        var parseConfigResult = this._ts.parseJsonConfigFileContent({
            'compilerOptions': options,
            'files': fileNames
        }, null, process.cwd());
        if (parseConfigResult.errors.length > 0) {
            this._reportDiagnostics(parseConfigResult.errors, result);
        }
        else {
            this._compileImpl(parseConfigResult.options, parseConfigResult.fileNames, result);
        }
    };
    TS_1_7_Adapter.prototype._compileImpl = function (options, fileNames, result) {
        var host = this._ts.createCompilerHost(options);
        var program = this._ts.createProgram(fileNames, options, new CompilerHost(host));
        this._reportDiagnostics(program.getOptionsDiagnostics(), result);
        this._reportDiagnostics(program.getGlobalDiagnostics(), result);
        this._reportDiagnostics(program.getSyntacticDiagnostics(), result);
        this._reportDiagnostics(program.getSemanticDiagnostics(), result);
        this._reportDiagnostics(program.getDeclarationDiagnostics(), result);
        var emitResult = program.emit(undefined, write, undefined);
        result.emitSkipped = emitResult.emitSkipped;
        this._reportDiagnostics(emitResult.diagnostics, result);
        // The 'sourceMaps' is an internal property, not exposed in the definition file.
        var sourceMaps = emitResult['sourceMaps'];
        function write(fileName, data) {
            result._create(options.rootDir, fileName, data);
        }
    };
    TS_1_7_Adapter.prototype._reportDiagnostics = function (diagnostics, result) {
        for (var _i = 0; _i < diagnostics.length; _i++) {
            var tsd = diagnostics[_i];
            result.diagnostics.push(this._mapDiagnostic(tsd));
        }
    };
    TS_1_7_Adapter.prototype._mapDiagnostic = function (tsd) {
        var cm = (_a = {},
            _a[this._ts.DiagnosticCategory.Warning] = _compiler.DiagnosticCategory.Warning,
            _a[this._ts.DiagnosticCategory.Error] = _compiler.DiagnosticCategory.Error,
            _a[this._ts.DiagnosticCategory.Message] = _compiler.DiagnosticCategory.Message,
            _a
        );
        var cd = diagnostic(tsd);
        if (tsd.file) {
            var p = this._ts.getLineAndCharacterOfPosition(tsd.file, tsd.start);
            cd.fileName = tsd.file.fileName;
            cd.start = tsd.start;
            cd.length = tsd.length;
            cd.line = p.line;
            cd.character = p.character;
        }
        return cd;
        function diagnostic(tsd) {
            if (_lang.isString(tsd.messageText)) {
                return new _compiler.Diagnostic(cm[tsd.category], tsd.code, tsd.messageText);
            }
            else {
                var tsc = tsd.messageText;
                return new _compiler.Diagnostic(cm[tsd.category], tsd.code, tsc.messageText, chain(tsc.next));
            }
        }
        function chain(tsc) {
            if (tsc) {
                return new _compiler.DiagnosticChain(cm[tsc.category], tsc.code, tsc.messageText, chain(tsc.next));
            }
            else {
                return null;
            }
        }
        var _a;
    };
    TS_1_7_Adapter.VERSION = '~1.7.2';
    return TS_1_7_Adapter;
})();
var CompilerHost = (function () {
    function CompilerHost(target) {
        this._target = target;
    }
    CompilerHost.prototype.writeFile = function (fileName, data, writeByteOrderMark, onError) {
        this._target.writeFile(fileName, data, writeByteOrderMark, onError);
    };
    CompilerHost.prototype.getSourceFile = function (fileName, languageVersion, onError) {
        return this._target.getSourceFile(fileName, languageVersion, onError);
    };
    CompilerHost.prototype.getDefaultLibFileName = function (options) {
        return this._target.getDefaultLibFileName(options);
    };
    CompilerHost.prototype.getCurrentDirectory = function () {
        return this._target.getCurrentDirectory();
    };
    CompilerHost.prototype.getCanonicalFileName = function (fileName) {
        return this._target.getCanonicalFileName(fileName);
    };
    CompilerHost.prototype.useCaseSensitiveFileNames = function () {
        return this._target.useCaseSensitiveFileNames();
    };
    CompilerHost.prototype.getNewLine = function () {
        return this._target.getNewLine();
    };
    CompilerHost.prototype.fileExists = function (fileName) {
        return this._target.fileExists(fileName);
    };
    CompilerHost.prototype.readFile = function (fileName) {
        return this._target.readFile(fileName);
    };
    return CompilerHost;
})();
module.exports = TS_1_7_Adapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVFNfMV83LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVFNfMV83LnRzIl0sIm5hbWVzIjpbIlRTXzFfN19BZGFwdGVyIiwiVFNfMV83X0FkYXB0ZXIuY29uc3RydWN0b3IiLCJUU18xXzdfQWRhcHRlci5jb21waWxlIiwiVFNfMV83X0FkYXB0ZXIuX2NvbXBpbGVJbXBsIiwiVFNfMV83X0FkYXB0ZXIuX2NvbXBpbGVJbXBsLndyaXRlIiwiVFNfMV83X0FkYXB0ZXIuX3JlcG9ydERpYWdub3N0aWNzIiwiVFNfMV83X0FkYXB0ZXIuX21hcERpYWdub3N0aWMiLCJUU18xXzdfQWRhcHRlci5fbWFwRGlhZ25vc3RpYy5kaWFnbm9zdGljIiwiVFNfMV83X0FkYXB0ZXIuX21hcERpYWdub3N0aWMuY2hhaW4iLCJDb21waWxlckhvc3QiLCJDb21waWxlckhvc3QuY29uc3RydWN0b3IiLCJDb21waWxlckhvc3Qud3JpdGVGaWxlIiwiQ29tcGlsZXJIb3N0LmdldFNvdXJjZUZpbGUiLCJDb21waWxlckhvc3QuZ2V0RGVmYXVsdExpYkZpbGVOYW1lIiwiQ29tcGlsZXJIb3N0LmdldEN1cnJlbnREaXJlY3RvcnkiLCJDb21waWxlckhvc3QuZ2V0Q2Fub25pY2FsRmlsZU5hbWUiLCJDb21waWxlckhvc3QudXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lcyIsIkNvbXBpbGVySG9zdC5nZXROZXdMaW5lIiwiQ29tcGlsZXJIb3N0LmZpbGVFeGlzdHMiLCJDb21waWxlckhvc3QucmVhZEZpbGUiXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQUdqRCxJQUFPLFNBQVMsV0FBVyxhQUFhLENBQUMsQ0FBQztBQUUxQyxJQUFPLEtBQUssV0FBVyxTQUFTLENBQUMsQ0FBQztBQUVsQztJQUdJQSx3QkFBb0JBLEdBQWNBO1FBQWRDLFFBQUdBLEdBQUhBLEdBQUdBLENBQVdBO0lBQUdBLENBQUNBO0lBRXRDRCxnQ0FBT0EsR0FBUEEsVUFBUUEsT0FBWUEsRUFBRUEsU0FBbUJBLEVB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QTtRQUNqQ00sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUN2REEsQ0FBQ0E7SUFFRE4sZ0RBQXlCQSxHQUF6QkE7UUFDSU8sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EseUJBQXlCQSxFQUFFQSxDQUFDQTtJQUNwREEsQ0FBQ0E7SUFFRFAsaUNBQVVBLEdBQVZBO1FBQ0lRLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO0lBQ3JDQSxDQUFDQTtJQUVEUixpQ0FBVUEsR0FBVkEsVUFBV0EsUUFBZ0JBO1FBQ3ZCUyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUM3Q0EsQ0FBQ0E7SUFFRFQsK0JBQVFBLEdBQVJBLFVBQVNBLFFBQWdCQTtRQUNyQlUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDM0NBLENBQUNBO0lBQ0xWLG1CQUFDQTtBQUFEQSxDQUFDQSxBQTFDRCxJQTBDQztBQUVELGlCQUFTLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9kL3R5cGVzY3JpcHQtMS43LmQudHNcIiAvPlxuXG5pbXBvcnQgdHMgPSBUU18xXzc7XG5pbXBvcnQgX2NvbXBpbGVyID0gcmVxdWlyZSgnLi4vY29tcGlsZXInKTtcbmltcG9ydCBfdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTtcbmltcG9ydCBfbGFuZyA9IHJlcXVpcmUoJy4uL2xhbmcnKTtcblxuY2xhc3MgVFNfMV83X0FkYXB0ZXIgaW1wbGVtZW50cyBfY29tcGlsZXIuQ29tcGlsZXIge1xuICAgIHN0YXRpYyBWRVJTSU9OID0gJ34xLjcuMic7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF90czogdHlwZW9mIHRzKSB7fVxuXG4gICAgY29tcGlsZShvcHRpb25zOiBhbnksIGZpbGVOYW1lczogc3RyaW5nW10sIHJlc3VsdDogX2NvbXBpbGVyLlJlc3VsdCkge1xuICAgICAgICBsZXQgcGFyc2VDb25maWdSZXN1bHQgPSB0aGlzLl90cy5wYXJzZUpzb25Db25maWdGaWxlQ29udGVudCh7XG4gICAgICAgICAgICAnY29tcGlsZXJPcHRpb25zJzogb3B0aW9ucyxcbiAgICAgICAgICAgICdmaWxlcyc6IGZpbGVOYW1lc1xuICAgICAgICB9LCBudWxsLCBwcm9jZXNzLmN3ZCgpKTtcblxuICAgICAgICBpZiAocGFyc2VDb25maWdSZXN1bHQuZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHBhcnNlQ29uZmlnUmVzdWx0LmVycm9ycywgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2NvbXBpbGVJbXBsKHBhcnNlQ29uZmlnUmVzdWx0Lm9wdGlvbnMsIHBhcnNlQ29uZmlnUmVzdWx0LmZpbGVOYW1lcywgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2NvbXBpbGVJbXBsKG9wdGlvbnM6IHRzLkNvbXBpbGVyT3B0aW9ucywgZmlsZU5hbWVzOiBzdHJpbmdbXSwgcmVzdWx0OiBfY29tcGlsZXIuUmVzdWx0KSB7XG4gICAgICAgIGxldCBob3N0ID0gdGhpcy5fdHMuY3JlYXRlQ29tcGlsZXJIb3N0KG9wdGlvbnMpO1xuICAgICAgICBsZXQgcHJvZ3JhbSA9IHRoaXMuX3RzLmNyZWF0ZVByb2dyYW0oZmlsZU5hbWVzLCBvcHRpb25zLCBuZXcgQ29tcGlsZXJIb3N0KGhvc3QpKTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXRPcHRpb25zRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXRHbG9iYWxEaWFnbm9zdGljcygpLCByZXN1bHQpO1xuICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwcm9ncmFtLmdldFN5bnRhY3RpY0RpYWdub3N0aWNzKCksIHJlc3VsdCk7XG4gICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHByb2dyYW0uZ2V0U2VtYW50aWNEaWFnbm9zdGljcygpLCByZXN1bHQpO1xuICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwcm9ncmFtLmdldERlY2xhcmF0aW9uRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgbGV0IGVtaXRSZXN1bHQgPSBwcm9ncmFtLmVtaXQodW5kZWZpbmVkLCB3cml0ZSwgdW5kZWZpbmVkKTtcbiAgICAgICAgcmVzdWx0LmVtaXRTa2lwcGVkID0gZW1pdFJlc3VsdC5lbWl0U2tpcHBlZDtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MoZW1pdFJlc3VsdC5kaWFnbm9zdGljcywgcmVzdWx0KTtcblxuICAgICAgICAvLyBUaGUgJ3NvdXJjZU1hcHMnIGlzIGFuIGludGVybmFsIHByb3BlcnR5LCBub3QgZXhwb3NlZCBpbiB0aGUgZGVmaW5pdGlvbiBmaWxlLlxuICAgICAgICBsZXQgc291cmNlTWFwcyA9IDx0cy5Tb3VyY2VNYXBEYXRhW10+ZW1pdFJlc3VsdFsnc291cmNlTWFwcyddO1xuXG4gICAgICAgIGZ1bmN0aW9uIHdyaXRlKGZpbGVOYW1lOiBzdHJpbmcsIGRhdGE6IHN0cmluZykge1xuICAgICAgICAgICAgcmVzdWx0Ll9jcmVhdGUob3B0aW9ucy5yb290RGlyLCBmaWxlTmFtZSwgZGF0YSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZXBvcnREaWFnbm9zdGljcyhkaWFnbm9zdGljczogdHMuRGlhZ25vc3RpY1tdLCByZXN1bHQ6IF9jb21waWxlci5SZXN1bHQpIHtcbiAgICAgICAgZm9yIChsZXQgdHNkIG9mIGRpYWdub3N0aWNzKSB7XG4gICAgICAgICAgICByZXN1bHQuZGlhZ25vc3RpY3MucHVzaCh0aGlzLl9tYXBEaWFnbm9zdGljKHRzZCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfbWFwRGlhZ25vc3RpYyh0c2Q6IHRzLkRpYWdub3N0aWMpOiBfY29tcGlsZXIuRGlhZ25vc3RpYyB7XG4gICAgICAgIGxldCBjbSA9IHtcbiAgICAgICAgICAgIFt0aGlzLl90cy5EaWFnbm9zdGljQ2F0ZWdvcnkuV2FybmluZ106IF9jb21waWxlci5EaWFnbm9zdGljQ2F0ZWdvcnkuV2FybmluZyxcbiAgICAgICAgICAgIFt0aGlzLl90cy5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3JdOiBfY29tcGlsZXIuRGlhZ25vc3RpY0NhdGVnb3J5LkVycm9yLFxuICAgICAgICAgICAgW3RoaXMuX3RzLkRpYWdub3N0aWNDYXRlZ29yeS5NZXNzYWdlXTogX2NvbXBpbGVyLkRpYWdub3N0aWNDYXRlZ29yeS5NZXNzYWdlLFxuICAgICAgICB9O1xuICAgICAgICBsZXQgY2QgPSBkaWFnbm9zdGljKHRzZCk7XG4gICAgICAgIGlmICh0c2QuZmlsZSkge1xuICAgICAgICAgICAgbGV0IHAgPSB0aGlzLl90cy5nZXRMaW5lQW5kQ2hhcmFjdGVyT2ZQb3NpdGlvbih0c2QuZmlsZSwgdHNkLnN0YXJ0KTtcbiAgICAgICAgICAgIGNkLmZpbGVOYW1lID0gdHNkLmZpbGUuZmlsZU5hbWU7XG4gICAgICAgICAgICBjZC5zdGFydCA9IHRzZC5zdGFydDtcbiAgICAgICAgICAgIGNkLmxlbmd0aCA9IHRzZC5sZW5ndGg7XG4gICAgICAgICAgICBjZC5saW5lID0gcC5saW5lO1xuICAgICAgICAgICAgY2QuY2hhcmFjdGVyID0gcC5jaGFyYWN0ZXI7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNkO1xuXG4gICAgICAgIGZ1bmN0aW9uIGRpYWdub3N0aWModHNkOiB0cy5EaWFnbm9zdGljKTogX2NvbXBpbGVyLkRpYWdub3N0aWMge1xuICAgICAgICAgICAgaWYgKF9sYW5nLmlzU3RyaW5nKHRzZC5tZXNzYWdlVGV4dCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IF9jb21waWxlci5EaWFnbm9zdGljKGNtW3RzZC5jYXRlZ29yeV0sIHRzZC5jb2RlLCA8c3RyaW5nPnRzZC5tZXNzYWdlVGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgdHNjID0gPHRzLkRpYWdub3N0aWNNZXNzYWdlQ2hhaW4+dHNkLm1lc3NhZ2VUZXh0O1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgX2NvbXBpbGVyLkRpYWdub3N0aWMoY21bdHNkLmNhdGVnb3J5XSwgdHNkLmNvZGUsIHRzYy5tZXNzYWdlVGV4dCwgY2hhaW4odHNjLm5leHQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGNoYWluKHRzYzogdHMuRGlhZ25vc3RpY01lc3NhZ2VDaGFpbik6IF9jb21waWxlci5EaWFnbm9zdGljQ2hhaW4ge1xuICAgICAgICAgICAgaWYgKHRzYykge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgX2NvbXBpbGVyLkRpYWdub3N0aWNDaGFpbihjbVt0c2MuY2F0ZWdvcnldLCB0c2MuY29kZSwgdHNjLm1lc3NhZ2VUZXh0LCBjaGFpbih0c2MubmV4dCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmNsYXNzIENvbXBpbGVySG9zdCBpbXBsZW1lbnRzIHRzLkNvbXBpbGVySG9zdCB7XG4gICAgcHJpdmF0ZSBfdGFyZ2V0OiB0cy5Db21waWxlckhvc3Q7XG5cbiAgICBjb25zdHJ1Y3Rvcih0YXJnZXQ6IHRzLkNvbXBpbGVySG9zdCkge1xuICAgICAgICB0aGlzLl90YXJnZXQgPSB0YXJnZXQ7XG4gICAgfVxuXG4gICAgd3JpdGVGaWxlKGZpbGVOYW1lOiBzdHJpbmcsIGRhdGE6IHN0cmluZywgd3JpdGVCeXRlT3JkZXJNYXJrOiBib29sZWFuLCBvbkVycm9yPzogKG1lc3NhZ2U6IHN0cmluZykgPT4gdm9pZCkge1xuICAgICAgICB0aGlzLl90YXJnZXQud3JpdGVGaWxlKGZpbGVOYW1lLCBkYXRhLCB3cml0ZUJ5dGVPcmRlck1hcmssIG9uRXJyb3IpO1xuICAgIH1cblxuICAgIGdldFNvdXJjZUZpbGUoZmlsZU5hbWU6IHN0cmluZywgbGFuZ3VhZ2VWZXJzaW9uOiB0cy5TY3JpcHRUYXJnZXQsIG9uRXJyb3I6IChtZXNzYWdlOiBzdHJpbmcpID0+IHZvaWQpOiB0cy5Tb3VyY2VGaWxlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5nZXRTb3VyY2VGaWxlKGZpbGVOYW1lLCBsYW5ndWFnZVZlcnNpb24sIG9uRXJyb3IpO1xuICAgIH1cblxuICAgIGdldERlZmF1bHRMaWJGaWxlTmFtZShvcHRpb25zOiB0cy5Db21waWxlck9wdGlvbnMpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LmdldERlZmF1bHRMaWJGaWxlTmFtZShvcHRpb25zKTtcbiAgICB9XG5cbiAgICBnZXRDdXJyZW50RGlyZWN0b3J5KCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZ2V0Q3VycmVudERpcmVjdG9yeSgpO1xuICAgIH1cblxuICAgIGdldENhbm9uaWNhbEZpbGVOYW1lKGZpbGVOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LmdldENhbm9uaWNhbEZpbGVOYW1lKGZpbGVOYW1lKTtcbiAgICB9XG5cbiAgICB1c2VDYXNlU2Vuc2l0aXZlRmlsZU5hbWVzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LnVzZUNhc2VTZW5zaXRpdmVGaWxlTmFtZXMoKTtcbiAgICB9XG5cbiAgICBnZXROZXdMaW5lKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZ2V0TmV3TGluZSgpO1xuICAgIH1cblxuICAgIGZpbGVFeGlzdHMoZmlsZU5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LmZpbGVFeGlzdHMoZmlsZU5hbWUpO1xuICAgIH1cblxuICAgIHJlYWRGaWxlKGZpbGVOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LnJlYWRGaWxlKGZpbGVOYW1lKTtcbiAgICB9XG59XG5cbmV4cG9ydCA9IFRTXzFfN19BZGFwdGVyO1xuIl19