/// <reference path="../d/typescript-1.7.d.ts" />
var _compiler = require('../compiler');
var _lang = require('../lang');
var TS_1_7_Adapter = (function () {
    function TS_1_7_Adapter(_ts) {
        this._ts = _ts;
    }
    TS_1_7_Adapter.prototype.compile = function (options, fileNames, result) {
        var parseConfigResult = this._ts.parseJsonConfigFileContent({
            'compilerOptions': options,
            'files': fileNames
        }, null, process.cwd());
        if (parseConfigResult.errors.length > 0) {
            this._reportDiagnostics(parseConfigResult.errors, result);
        }
        else {
            this._compileImpl(parseConfigResult.options, parseConfigResult.fileNames, result);
        }
    };
    TS_1_7_Adapter.prototype._compileImpl = function (options, fileNames, result) {
        var host = this._ts.createCompilerHost(options);
        var program = this._ts.createProgram(fileNames, options, new CompilerHost(host));
        this._reportDiagnostics(program.getOptionsDiagnostics(), result);
        this._reportDiagnostics(program.getGlobalDiagnostics(), result);
        this._reportDiagnostics(program.getSyntacticDiagnostics(), result);
        this._reportDiagnostics(program.getSemanticDiagnostics(), result);
        this._reportDiagnostics(program.getDeclarationDiagnostics(), result);
        var emitResult = program.emit(undefined, write, undefined);
        result.emitSkipped = emitResult.emitSkipped;
        this._reportDiagnostics(emitResult.diagnostics, result);
        function write(fileName, data) {
            result._create(options.rootDir, fileName, data);
        }
    };
    TS_1_7_Adapter.prototype._reportDiagnostics = function (diagnostics, result) {
        for (var _i = 0; _i < diagnostics.length; _i++) {
            var tsd = diagnostics[_i];
            result.diagnostics.push(this._mapDiagnostic(tsd));
        }
    };
    TS_1_7_Adapter.prototype._mapDiagnostic = function (tsd) {
        var cm = (_a = {},
            _a[this._ts.DiagnosticCategory.Warning] = _compiler.DiagnosticCategory.Warning,
            _a[this._ts.DiagnosticCategory.Error] = _compiler.DiagnosticCategory.Error,
            _a[this._ts.DiagnosticCategory.Message] = _compiler.DiagnosticCategory.Message,
            _a
        );
        var cd = diagnostic(tsd);
        if (tsd.file) {
            var p = this._ts.getLineAndCharacterOfPosition(tsd.file, tsd.start);
            cd.fileName = tsd.file.fileName;
            cd.start = tsd.start;
            cd.length = tsd.length;
            cd.line = p.line;
            cd.character = p.character;
        }
        return cd;
        function diagnostic(tsd) {
            if (_lang.isString(tsd.messageText)) {
                return new _compiler.Diagnostic(cm[tsd.category], tsd.code, tsd.messageText);
            }
            else {
                var tsc = tsd.messageText;
                return new _compiler.Diagnostic(cm[tsd.category], tsd.code, tsc.messageText, chain(tsc.next));
            }
        }
        function chain(tsc) {
            if (tsc) {
                return new _compiler.DiagnosticChain(cm[tsc.category], tsc.code, tsc.messageText, chain(tsc.next));
            }
            else {
                return null;
            }
        }
        var _a;
    };
    TS_1_7_Adapter.VERSION = '~1.7.2';
    return TS_1_7_Adapter;
})();
var CompilerHost = (function () {
    function CompilerHost(target) {
        this._target = target;
    }
    CompilerHost.prototype.writeFile = function (fileName, data, writeByteOrderMark, onError) {
        this._target.writeFile(fileName, data, writeByteOrderMark, onError);
    };
    CompilerHost.prototype.getSourceFile = function (fileName, languageVersion, onError) {
        return this._target.getSourceFile(fileName, languageVersion, onError);
    };
    CompilerHost.prototype.getDefaultLibFileName = function (options) {
        return this._target.getDefaultLibFileName(options);
    };
    CompilerHost.prototype.getCurrentDirectory = function () {
        return this._target.getCurrentDirectory();
    };
    CompilerHost.prototype.getCanonicalFileName = function (fileName) {
        return this._target.getCanonicalFileName(fileName);
    };
    CompilerHost.prototype.useCaseSensitiveFileNames = function () {
        return this._target.useCaseSensitiveFileNames();
    };
    CompilerHost.prototype.getNewLine = function () {
        return this._target.getNewLine();
    };
    CompilerHost.prototype.fileExists = function (fileName) {
        return this._target.fileExists(fileName);
    };
    CompilerHost.prototype.readFile = function (fileName) {
        return this._target.readFile(fileName);
    };
    return CompilerHost;
})();
module.exports = TS_1_7_Adapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVFNfMV83LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVFNfMV83LnRzIl0sIm5hbWVzIjpbIlRTXzFfN19BZGFwdGVyIiwiVFNfMV83X0FkYXB0ZXIuY29uc3RydWN0b3IiLCJUU18xXzdfQWRhcHRlci5jb21waWxlIiwiVFNfMV83X0FkYXB0ZXIuX2NvbXBpbGVJbXBsIiwiVFNfMV83X0FkYXB0ZXIuX2NvbXBpbGVJbXBsLndyaXRlIiwiVFNfMV83X0FkYXB0ZXIuX3JlcG9ydERpYWdub3N0aWNzIiwiVFNfMV83X0FkYXB0ZXIuX21hcERpYWdub3N0aWMiLCJUU18xXzdfQWRhcHRlci5fbWFwRGlhZ25vc3RpYy5kaWFnbm9zdGljIiwiVFNfMV83X0FkYXB0ZXIuX21hcERpYWdub3N0aWMuY2hhaW4iLCJDb21waWxlckhvc3QiLCJDb21waWxlckhvc3QuY29uc3RydWN0b3IiLCJDb21waWxlckhvc3Qud3JpdGVGaWxlIiwiQ29tcGlsZXJIb3N0LmdldFNvdXJjZUZpbGUiLCJDb21waWxlckhvc3QuZ2V0RGVmYXVsdExpYkZpbGVOYW1lIiwiQ29tcGlsZXJIb3N0LmdldEN1cnJlbnREaXJlY3RvcnkiLCJDb21waWxlckhvc3QuZ2V0Q2Fub25pY2FsRmlsZU5hbWUiLCJDb21waWxlckhvc3QudXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lcyIsIkNvbXBpbGVySG9zdC5nZXROZXdMaW5lIiwiQ29tcGlsZXJIb3N0LmZpbGVFeGlzdHMiLCJDb21waWxlckhvc3QucmVhZEZpbGUiXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQUdqRCxJQUFPLFNBQVMsV0FBVyxhQUFhLENBQUMsQ0FBQztBQUUxQyxJQUFPLEtBQUssV0FBVyxTQUFTLENBQUMsQ0FBQztBQUVsQztJQUdJQSx3QkFBb0JBLEdBQWNBO1FBQWRDLFFBQUdBLEdBQUhBLEdBQUdBLENBQVdBO0lBQUdBLENBQUNBO0lBRXRDRCxnQ0FBT0EsR0FBUEEsVUFBUUEsT0FBWUEsRUFBRUEsU0FBbUJBLEVBQUVBLE1BQXdCQTtRQUMvREUsSUFBSUEsaUJBQWlCQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSwwQkFBMEJBLENBQUNBO1lBQ3hEQSxpQkFBaUJBLEVBQUVBLE9BQU9BO1lBQzFCQSxPQUFPQSxFQUFFQSxTQUFTQTtTQUNyQkEsRUFBRUEsSUFBSUEsRUFBRUEsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFFeEJBLEVBQUVBLENBQUNBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdENBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxNQUFNQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUM5REEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDRkEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxPQUFPQSxFQUFFQSxpQkFBaUJBLENBQUNBLFNBQVNBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO1FBQ3RGQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVPRixxQ0FBWUEsR0FBcEJBLFVBQXFCQSxPQUEyQkEsRUFBRUEsU0FBbUJBLEVBQUVBLE1BQXdCQTtRQUMzRkcsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtRQUNoREEsSUFBSUEsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsU0FBU0EsRUFBRUEsT0FBT0EsRUFBRUEsSUFBSUEsWUFBWUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDakZBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EscUJBQXFCQSxFQUFFQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUNqRUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxPQUFPQSxDQUFDQSxvQkFBb0JBLEVBQUVBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO1FBQ2hFQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLE9BQU9BLENBQUNBLHVCQUF1QkEsRUFBRUEsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDbkVBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0Esc0JBQXNCQSxFQUFFQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUNsRUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxPQUFPQSxDQUFDQSx5QkFBeUJBLEVBQUVBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO1FBQ3JFQSxJQUFJQSxVQUFVQSxHQUFHQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxFQUFFQSxLQUFLQSxFQUFFQSxTQUFTQSxDQUFDQSxDQUFDQTtRQUMzREEsTUFBTUEsQ0FBQ0EsV0FBV0EsR0FBR0EsVUFBVUEsQ0FBQ0EsV0FBV0EsQ0FBQ0E7UUFDNUNBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsV0FBV0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFFeERBLGVBQWVBLFFBQWdCQSxFQUFFQSxJQUFZQTtZQUN6Q0MsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsT0FBT0EsRUFBRUEsUUFBUUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDcERBLENBQUNBO0lBQ0xELENBQUNBO0lBRU9ILDJDQUFrQkEsR0FBMUJBLFVBQTJCQSxXQUE0QkEsRUFBRUEsTUFBd0JBO1FBQzdFSyxHQUFHQSxDQUFDQSxDQUFZQSxVQUFXQSxFQUF0QkEsdUJBQU9BLEVBQVBBLElBQXNCQSxDQUFDQTtZQUF2QkEsSUFBSUEsR0FBR0EsR0FBSUEsV0FBV0EsSUFBZkE7WUFDUkEsTUFBTUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7U0FDckRBO0lBQ0xBLENBQUNBO0lBRU9MLHVDQUFjQSxHQUF0QkEsVUFBdUJBLEdBQWtCQTtRQUNyQ00sSUFBSUEsRUFBRUEsR0FBR0E7WUFDTEEsR0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFFQSxTQUFTQSxDQUFDQSxrQkFBa0JBLENBQUNBLE9BQU9BO1lBQzNFQSxHQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxrQkFBa0JBLENBQUNBLEtBQUtBLENBQUNBLEdBQUVBLFNBQVNBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsS0FBS0E7WUFDdkVBLEdBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBRUEsU0FBU0EsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxPQUFPQTs7U0FDOUVBLENBQUNBO1FBQ0ZBLElBQUlBLEVBQUVBLEdBQUdBLFVBQVVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3pCQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNYQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSw2QkFBNkJBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLEVBQUVBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBQ3BFQSxFQUFFQSxDQUFDQSxRQUFRQSxHQUFHQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQTtZQUNoQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsR0FBR0EsR0FBR0EsQ0FBQ0EsS0FBS0EsQ0FBQ0E7WUFDckJBLEVBQUVBLENBQUNBLE1BQU1BLEdBQUdBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBO1lBQ3ZCQSxFQUFFQSxDQUFDQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQTtZQUNqQkEsRUFBRUEsQ0FBQ0EsU0FBU0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0E7UUFDL0JBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLEVBQUVBLENBQUNBO1FBRVZBLG9CQUFvQkEsR0FBa0JBO1lBQ2xDQyxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxRQUFRQSxDQUFDQSxHQUFHQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDbENBLE1BQU1BLENBQUNBLElBQUlBLFNBQVNBLENBQUNBLFVBQVVBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLENBQUNBLEVBQUVBLEdBQUdBLENBQUNBLElBQUlBLEVBQVVBLEdBQUdBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO1lBQ3pGQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDRkEsSUFBSUEsR0FBR0EsR0FBOEJBLEdBQUdBLENBQUNBLFdBQVdBLENBQUNBO2dCQUNyREEsTUFBTUEsQ0FBQ0EsSUFBSUEsU0FBU0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsRUFBRUEsR0FBR0EsQ0FBQ0EsSUFBSUEsRUFBRUEsR0FBR0EsQ0FBQ0EsV0FBV0EsRUFBRUEsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbEdBLENBQUNBO1FBQ0xBLENBQUNBO1FBRURELGVBQWVBLEdBQThCQTtZQUN6Q0UsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ05BLE1BQU1BLENBQUNBLElBQUlBLFNBQVNBLENBQUNBLGVBQWVBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLENBQUNBLEVBQUVBLEdBQUdBLENBQUNBLElBQUlBLEVBQUVBLEdBQUdBLENBQUNBLFdBQVdBLEVBQUVBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZHQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDRkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7WUFDaEJBLENBQUNBO1FBQ0xBLENBQUNBOztJQUNMRixDQUFDQTtJQTVFTU4sc0JBQU9BLEdBQUdBLFFBQVFBLENBQUNBO0lBNkU5QkEscUJBQUNBO0FBQURBLENBQUNBLEFBOUVELElBOEVDO0FBRUQ7SUFHSVMsc0JBQVlBLE1BQXVCQTtRQUMvQkMsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsTUFBTUEsQ0FBQ0E7SUFDMUJBLENBQUNBO0lBRURELGdDQUFTQSxHQUFUQSxVQUFVQSxRQUFnQkEsRUFBRUEsSUFBWUEsRUFBRUEsa0JBQTJCQSxFQUFFQSxPQUFtQ0E7UUFDdEdFLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLEVBQUVBLElBQUlBLEVBQUVBLGtCQUFrQkEsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFDeEVBLENBQUNBO0lBRURGLG9DQUFhQSxHQUFiQSxVQUFjQSxRQUFnQkEsRUFBRUEsZUFBZ0NBLEVBQUVBLE9BQWtDQTtRQUNoR0csTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsUUFBUUEsRUFBRUEsZUFBZUEsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFDMUVBLENBQUNBO0lBRURILDRDQUFxQkEsR0FBckJBLFVBQXNCQSxPQUEyQkE7UUFDN0NJLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLHFCQUFxQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFDdkRBLENBQUNBO0lBRURKLDBDQUFtQkEsR0FBbkJBO1FBQ0lLLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLG1CQUFtQkEsRUFBRUEsQ0FBQ0E7SUFDOUNBLENBQUNBO0lBRURMLDJDQUFvQkEsR0FBcEJBLFVBQXFCQSxRQUFnQkE7UUFDakNNLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLG9CQUFvQkEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDdkRBLENBQUNBO0lBRUROLGdEQUF5QkEsR0FBekJBO1FBQ0lPLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLHlCQUF5QkEsRUFBRUEsQ0FBQ0E7SUFDcERBLENBQUNBO0lBRURQLGlDQUFVQSxHQUFWQTtRQUNJUSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQTtJQUNyQ0EsQ0FBQ0E7SUFFRFIsaUNBQVVBLEdBQVZBLFVBQVdBLFFBQWdCQTtRQUN2QlMsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDN0NBLENBQUNBO0lBRURULCtCQUFRQSxHQUFSQSxVQUFTQSxRQUFnQkE7UUFDckJVLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO0lBQzNDQSxDQUFDQTtJQUNMVixtQkFBQ0E7QUFBREEsQ0FBQ0EsQUExQ0QsSUEwQ0M7QUFFRCxpQkFBUyxjQUFjLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vZC90eXBlc2NyaXB0LTEuNy5kLnRzXCIgLz5cblxuaW1wb3J0IHRzID0gVFNfMV83O1xuaW1wb3J0IF9jb21waWxlciA9IHJlcXVpcmUoJy4uL2NvbXBpbGVyJyk7XG5pbXBvcnQgX3V0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7XG5pbXBvcnQgX2xhbmcgPSByZXF1aXJlKCcuLi9sYW5nJyk7XG5cbmNsYXNzIFRTXzFfN19BZGFwdGVyIGltcGxlbWVudHMgX2NvbXBpbGVyLkNvbXBpbGVyIHtcbiAgICBzdGF0aWMgVkVSU0lPTiA9ICd+MS43LjInO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfdHM6IHR5cGVvZiB0cykge31cblxuICAgIGNvbXBpbGUob3B0aW9uczogYW55LCBmaWxlTmFtZXM6IHN0cmluZ1tdLCByZXN1bHQ6IF9jb21waWxlci5SZXN1bHQpIHtcbiAgICAgICAgbGV0IHBhcnNlQ29uZmlnUmVzdWx0ID0gdGhpcy5fdHMucGFyc2VKc29uQ29uZmlnRmlsZUNvbnRlbnQoe1xuICAgICAgICAgICAgJ2NvbXBpbGVyT3B0aW9ucyc6IG9wdGlvbnMsXG4gICAgICAgICAgICAnZmlsZXMnOiBmaWxlTmFtZXNcbiAgICAgICAgfSwgbnVsbCwgcHJvY2Vzcy5jd2QoKSk7XG5cbiAgICAgICAgaWYgKHBhcnNlQ29uZmlnUmVzdWx0LmVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwYXJzZUNvbmZpZ1Jlc3VsdC5lcnJvcnMsIHJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9jb21waWxlSW1wbChwYXJzZUNvbmZpZ1Jlc3VsdC5vcHRpb25zLCBwYXJzZUNvbmZpZ1Jlc3VsdC5maWxlTmFtZXMsIHJlc3VsdCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9jb21waWxlSW1wbChvcHRpb25zOiB0cy5Db21waWxlck9wdGlvbnMsIGZpbGVOYW1lczogc3RyaW5nW10sIHJlc3VsdDogX2NvbXBpbGVyLlJlc3VsdCkge1xuICAgICAgICBsZXQgaG9zdCA9IHRoaXMuX3RzLmNyZWF0ZUNvbXBpbGVySG9zdChvcHRpb25zKTtcbiAgICAgICAgbGV0IHByb2dyYW0gPSB0aGlzLl90cy5jcmVhdGVQcm9ncmFtKGZpbGVOYW1lcywgb3B0aW9ucywgbmV3IENvbXBpbGVySG9zdChob3N0KSk7XG4gICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHByb2dyYW0uZ2V0T3B0aW9uc0RpYWdub3N0aWNzKCksIHJlc3VsdCk7XG4gICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKHByb2dyYW0uZ2V0R2xvYmFsRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXRTeW50YWN0aWNEaWFnbm9zdGljcygpLCByZXN1bHQpO1xuICAgICAgICB0aGlzLl9yZXBvcnREaWFnbm9zdGljcyhwcm9ncmFtLmdldFNlbWFudGljRGlhZ25vc3RpY3MoKSwgcmVzdWx0KTtcbiAgICAgICAgdGhpcy5fcmVwb3J0RGlhZ25vc3RpY3MocHJvZ3JhbS5nZXREZWNsYXJhdGlvbkRpYWdub3N0aWNzKCksIHJlc3VsdCk7XG4gICAgICAgIGxldCBlbWl0UmVzdWx0ID0gcHJvZ3JhbS5lbWl0KHVuZGVmaW5lZCwgd3JpdGUsIHVuZGVmaW5lZCk7XG4gICAgICAgIHJlc3VsdC5lbWl0U2tpcHBlZCA9IGVtaXRSZXN1bHQuZW1pdFNraXBwZWQ7XG4gICAgICAgIHRoaXMuX3JlcG9ydERpYWdub3N0aWNzKGVtaXRSZXN1bHQuZGlhZ25vc3RpY3MsIHJlc3VsdCk7XG5cbiAgICAgICAgZnVuY3Rpb24gd3JpdGUoZmlsZU5hbWU6IHN0cmluZywgZGF0YTogc3RyaW5nKSB7XG4gICAgICAgICAgICByZXN1bHQuX2NyZWF0ZShvcHRpb25zLnJvb3REaXIsIGZpbGVOYW1lLCBkYXRhKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3JlcG9ydERpYWdub3N0aWNzKGRpYWdub3N0aWNzOiB0cy5EaWFnbm9zdGljW10sIHJlc3VsdDogX2NvbXBpbGVyLlJlc3VsdCkge1xuICAgICAgICBmb3IgKGxldCB0c2Qgb2YgZGlhZ25vc3RpY3MpIHtcbiAgICAgICAgICAgIHJlc3VsdC5kaWFnbm9zdGljcy5wdXNoKHRoaXMuX21hcERpYWdub3N0aWModHNkKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9tYXBEaWFnbm9zdGljKHRzZDogdHMuRGlhZ25vc3RpYyk6IF9jb21waWxlci5EaWFnbm9zdGljIHtcbiAgICAgICAgbGV0IGNtID0ge1xuICAgICAgICAgICAgW3RoaXMuX3RzLkRpYWdub3N0aWNDYXRlZ29yeS5XYXJuaW5nXTogX2NvbXBpbGVyLkRpYWdub3N0aWNDYXRlZ29yeS5XYXJuaW5nLFxuICAgICAgICAgICAgW3RoaXMuX3RzLkRpYWdub3N0aWNDYXRlZ29yeS5FcnJvcl06IF9jb21waWxlci5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3IsXG4gICAgICAgICAgICBbdGhpcy5fdHMuRGlhZ25vc3RpY0NhdGVnb3J5Lk1lc3NhZ2VdOiBfY29tcGlsZXIuRGlhZ25vc3RpY0NhdGVnb3J5Lk1lc3NhZ2UsXG4gICAgICAgIH07XG4gICAgICAgIGxldCBjZCA9IGRpYWdub3N0aWModHNkKTtcbiAgICAgICAgaWYgKHRzZC5maWxlKSB7XG4gICAgICAgICAgICBsZXQgcCA9IHRoaXMuX3RzLmdldExpbmVBbmRDaGFyYWN0ZXJPZlBvc2l0aW9uKHRzZC5maWxlLCB0c2Quc3RhcnQpO1xuICAgICAgICAgICAgY2QuZmlsZU5hbWUgPSB0c2QuZmlsZS5maWxlTmFtZTtcbiAgICAgICAgICAgIGNkLnN0YXJ0ID0gdHNkLnN0YXJ0O1xuICAgICAgICAgICAgY2QubGVuZ3RoID0gdHNkLmxlbmd0aDtcbiAgICAgICAgICAgIGNkLmxpbmUgPSBwLmxpbmU7XG4gICAgICAgICAgICBjZC5jaGFyYWN0ZXIgPSBwLmNoYXJhY3RlcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2Q7XG5cbiAgICAgICAgZnVuY3Rpb24gZGlhZ25vc3RpYyh0c2Q6IHRzLkRpYWdub3N0aWMpOiBfY29tcGlsZXIuRGlhZ25vc3RpYyB7XG4gICAgICAgICAgICBpZiAoX2xhbmcuaXNTdHJpbmcodHNkLm1lc3NhZ2VUZXh0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgX2NvbXBpbGVyLkRpYWdub3N0aWMoY21bdHNkLmNhdGVnb3J5XSwgdHNkLmNvZGUsIDxzdHJpbmc+dHNkLm1lc3NhZ2VUZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCB0c2MgPSA8dHMuRGlhZ25vc3RpY01lc3NhZ2VDaGFpbj50c2QubWVzc2FnZVRleHQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBfY29tcGlsZXIuRGlhZ25vc3RpYyhjbVt0c2QuY2F0ZWdvcnldLCB0c2QuY29kZSwgdHNjLm1lc3NhZ2VUZXh0LCBjaGFpbih0c2MubmV4dCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gY2hhaW4odHNjOiB0cy5EaWFnbm9zdGljTWVzc2FnZUNoYWluKTogX2NvbXBpbGVyLkRpYWdub3N0aWNDaGFpbiB7XG4gICAgICAgICAgICBpZiAodHNjKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBfY29tcGlsZXIuRGlhZ25vc3RpY0NoYWluKGNtW3RzYy5jYXRlZ29yeV0sIHRzYy5jb2RlLCB0c2MubWVzc2FnZVRleHQsIGNoYWluKHRzYy5uZXh0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgQ29tcGlsZXJIb3N0IGltcGxlbWVudHMgdHMuQ29tcGlsZXJIb3N0IHtcbiAgICBwcml2YXRlIF90YXJnZXQ6IHRzLkNvbXBpbGVySG9zdDtcblxuICAgIGNvbnN0cnVjdG9yKHRhcmdldDogdHMuQ29tcGlsZXJIb3N0KSB7XG4gICAgICAgIHRoaXMuX3RhcmdldCA9IHRhcmdldDtcbiAgICB9XG5cbiAgICB3cml0ZUZpbGUoZmlsZU5hbWU6IHN0cmluZywgZGF0YTogc3RyaW5nLCB3cml0ZUJ5dGVPcmRlck1hcms6IGJvb2xlYW4sIG9uRXJyb3I/OiAobWVzc2FnZTogc3RyaW5nKSA9PiB2b2lkKSB7XG4gICAgICAgIHRoaXMuX3RhcmdldC53cml0ZUZpbGUoZmlsZU5hbWUsIGRhdGEsIHdyaXRlQnl0ZU9yZGVyTWFyaywgb25FcnJvcik7XG4gICAgfVxuXG4gICAgZ2V0U291cmNlRmlsZShmaWxlTmFtZTogc3RyaW5nLCBsYW5ndWFnZVZlcnNpb246IHRzLlNjcmlwdFRhcmdldCwgb25FcnJvcjogKG1lc3NhZ2U6IHN0cmluZykgPT4gdm9pZCk6IHRzLlNvdXJjZUZpbGUge1xuICAgICAgICByZXR1cm4gdGhpcy5fdGFyZ2V0LmdldFNvdXJjZUZpbGUoZmlsZU5hbWUsIGxhbmd1YWdlVmVyc2lvbiwgb25FcnJvcik7XG4gICAgfVxuXG4gICAgZ2V0RGVmYXVsdExpYkZpbGVOYW1lKG9wdGlvbnM6IHRzLkNvbXBpbGVyT3B0aW9ucyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZ2V0RGVmYXVsdExpYkZpbGVOYW1lKG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGdldEN1cnJlbnREaXJlY3RvcnkoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5nZXRDdXJyZW50RGlyZWN0b3J5KCk7XG4gICAgfVxuXG4gICAgZ2V0Q2Fub25pY2FsRmlsZU5hbWUoZmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZ2V0Q2Fub25pY2FsRmlsZU5hbWUoZmlsZU5hbWUpO1xuICAgIH1cblxuICAgIHVzZUNhc2VTZW5zaXRpdmVGaWxlTmFtZXMoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQudXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lcygpO1xuICAgIH1cblxuICAgIGdldE5ld0xpbmUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RhcmdldC5nZXROZXdMaW5lKCk7XG4gICAgfVxuXG4gICAgZmlsZUV4aXN0cyhmaWxlTmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQuZmlsZUV4aXN0cyhmaWxlTmFtZSk7XG4gICAgfVxuXG4gICAgcmVhZEZpbGUoZmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90YXJnZXQucmVhZEZpbGUoZmlsZU5hbWUpO1xuICAgIH1cbn1cblxuZXhwb3J0ID0gVFNfMV83X0FkYXB0ZXI7XG4iXX0=